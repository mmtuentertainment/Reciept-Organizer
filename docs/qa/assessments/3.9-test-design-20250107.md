# Test Design: Story 3.9 - Date Range Selection for Export

Date: 2025-01-07
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 32
- Unit tests: 18 (56%)
- Integration tests: 10 (31%)
- E2E tests: 4 (13%)
- Priority distribution: P0: 12, P1: 14, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Calendar picker with preset options (This Month, Last Month, Custom)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 3.9-UNIT-001 | Unit | P0 | Calculate "This Month" date range correctly | Pure date logic, critical for accuracy |
| 3.9-UNIT-002 | Unit | P0 | Calculate "Last Month" date range correctly | Pure date logic, handles month boundaries |
| 3.9-UNIT-003 | Unit | P0 | Calculate "Last 30 Days" range | Simple calculation, frequently used |
| 3.9-UNIT-004 | Unit | P0 | Calculate "Last 90 Days" range | Simple calculation, business reporting |
| 3.9-UNIT-005 | Unit | P1 | Handle month boundary edge cases (Janâ†’Dec) | Date logic complexity |
| 3.9-UNIT-006 | Unit | P1 | Enforce 2-year historical limit | Business rule validation |
| 3.9-WIDGET-001 | Widget | P0 | Preset buttons display and respond | UI functionality |
| 3.9-WIDGET-002 | Widget | P0 | Custom date picker opens and accepts input | Core UI interaction |
| 3.9-WIDGET-003 | Widget | P1 | Selected preset visually indicated | User feedback |
| 3.9-WIDGET-004 | Widget | P2 | Material 3 theming applied correctly | Visual consistency |
| 3.9-INT-001 | Integration | P0 | Custom date selection updates provider | State management flow |
| 3.9-INT-002 | Integration | P1 | Invalid date range shows error | Error handling |

### AC2: Display receipt count for selected range

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 3.9-UNIT-007 | Unit | P0 | Repository date query with valid range | Core data access |
| 3.9-UNIT-008 | Unit | P0 | Repository handles multiple date formats | Mitigates DATA-001 risk |
| 3.9-UNIT-009 | Unit | P1 | Repository returns empty list for no matches | Edge case handling |
| 3.9-UNIT-010 | Unit | P1 | Repository SQL injection prevention | Security validation |
| 3.9-PERF-001 | Unit | P0 | Query performs <200ms with 1000 receipts | Mitigates PERF-001 risk |
| 3.9-PERF-002 | Unit | P1 | Query performs <500ms with 5000 receipts | Scalability check |
| 3.9-INT-003 | Integration | P0 | Provider fetches count on date change | Core functionality |
| 3.9-INT-004 | Integration | P0 | Loading state shown during query | User feedback |
| 3.9-INT-005 | Integration | P1 | Count updates reactively in UI | State management |
| 3.9-WIDGET-005 | Widget | P1 | Receipt count badge displays correctly | UI verification |
| 3.9-E2E-001 | E2E | P1 | Select date range and verify count | Full user journey |

### AC3: Persist last selected range for convenience

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 3.9-UNIT-011 | Unit | P0 | Settings repository stores date range JSON | Core persistence |
| 3.9-UNIT-012 | Unit | P0 | Settings repository retrieves saved range | Core persistence |
| 3.9-UNIT-013 | Unit | P1 | Handle corrupted JSON gracefully | Error resilience |
| 3.9-UNIT-014 | Unit | P1 | Default to "Last 30 Days" if no saved value | User experience |
| 3.9-UNIT-015 | Unit | P2 | Validate date range before saving | Data integrity |
| 3.9-INT-006 | Integration | P0 | Settings persist across provider lifecycle | State persistence |
| 3.9-INT-007 | Integration | P1 | Migration for users without preference | Backward compatibility |
| 3.9-INT-008 | Integration | P2 | Settings update on every selection | Immediate persistence |
| 3.9-E2E-002 | E2E | P0 | App restart restores last selection | Core user experience |
| 3.9-E2E-003 | E2E | P1 | Settings survive app update | Long-term persistence |

### Additional Test Scenarios

#### Performance & Error Handling

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 3.9-UNIT-016 | Unit | P2 | Memory efficient for large result sets | Resource management |
| 3.9-UNIT-017 | Unit | P2 | Date parser handles null/empty dates | Defensive programming |
| 3.9-UNIT-018 | Unit | P2 | Provider disposes resources properly | Memory leak prevention |
| 3.9-INT-009 | Integration | P1 | Rapid date changes don't cause race conditions | Concurrency handling |
| 3.9-INT-010 | Integration | P2 | Export screen navigation works correctly | User flow |
| 3.9-E2E-004 | E2E | P1 | Complete export flow with date selection | End-to-end validation |

## Risk Coverage

| Risk ID | Mitigating Tests | Coverage Level |
|---------|------------------|----------------|
| PERF-001 | 3.9-PERF-001, 3.9-PERF-002, 3.9-UNIT-016 | High |
| DATA-001 | 3.9-UNIT-008, 3.9-UNIT-017, 3.9-INT-002 | High |
| TECH-001 | 3.9-UNIT-007, 3.9-UNIT-009, 3.9-UNIT-010 | Medium |
| TECH-002 | 3.9-INT-003, 3.9-INT-005, 3.9-UNIT-018 | Medium |
| DATA-002 | 3.9-UNIT-013, 3.9-INT-007 | Medium |

## Test Data Requirements

### Date Scenarios
```dart
// Standard cases
- Today's date
- Start of current month
- End of last month
- Leap year dates (Feb 29)
- Year boundaries (Dec 31, Jan 1)

// Edge cases
- Invalid dates: "99/99/9999"
- Future dates (should be rejected)
- Dates > 2 years old
- Null/empty date strings
- Various formats: "01/15/2024", "15/01/2024", "2024-01-15"
```

### Receipt Data Sets
```dart
// Performance testing
- Empty database
- 100 receipts (evenly distributed)
- 1,000 receipts (clustered in recent months)
- 5,000 receipts (2-year span)
- Receipts with missing dates
- Receipts with malformed dates
```

### Settings Data
```dart
// Persistence testing
- Valid saved preferences
- Corrupted JSON
- Missing preferences
- Legacy format (migration test)
```

## Recommended Execution Order

1. **P0 Unit Tests** (12 tests)
   - Date calculations (3.9-UNIT-001 to 004)
   - Repository queries (3.9-UNIT-007, 008)
   - Performance benchmarks (3.9-PERF-001)
   - Settings persistence (3.9-UNIT-011, 012)

2. **P0 Integration Tests** (4 tests)
   - State management (3.9-INT-001, 003, 004)
   - Settings persistence (3.9-INT-006)

3. **P0 E2E Tests** (1 test)
   - App restart persistence (3.9-E2E-002)

4. **P1 Tests** (14 tests)
   - Edge cases and error handling
   - Additional performance checks
   - User experience validations

5. **P2 Tests** (6 tests)
   - Visual consistency
   - Resource management
   - Nice-to-have validations

## Test Implementation Guidelines

### Unit Tests
- Use `flutter_test` package
- Mock all dependencies (Repository, Settings)
- Focus on pure logic validation
- Each test should run in <100ms

### Widget Tests
- Use `flutter_test` with `testWidgets`
- Mock providers and services
- Test user interactions
- Verify visual states

### Integration Tests
- Test provider/repository interactions
- Use real SQLite in-memory database
- Verify state propagation
- Test error scenarios

### E2E Tests
- Use `integration_test` package
- Test complete user journeys
- Include app lifecycle events
- Measure real performance

## Test Coverage Metrics

Target coverage by component:
- DateRangePickerWidget: 95%
- DateRangeProvider: 90%
- ReceiptRepository extension: 95%
- SettingsRepository extension: 90%
- ExportScreen: 85%

## Long-term Test Maintenance

- Keep date calculation tests updated with business rules
- Performance benchmarks in CI pipeline
- Regular review of test data freshness
- Monitor flaky tests and fix root causes