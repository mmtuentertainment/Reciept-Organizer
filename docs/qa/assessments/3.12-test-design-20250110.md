# Test Design: Story 3.12 - Export Validation

Date: 2025-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 42
- Unit tests: 24 (57%)
- Integration tests: 12 (29%)
- E2E tests: 6 (14%)
- Priority distribution: P0: 18, P1: 15, P2: 9

## Test Philosophy

Given the critical nature of export validation (preventing failed imports into accounting software), this test design emphasizes:
- **Heavy unit test coverage** for validation rules (fast feedback)
- **Integration testing** for provider interactions and state management
- **Strategic E2E testing** for critical export paths
- **Security-first approach** due to CSV injection risks

## Test Scenarios by Acceptance Criteria

### AC1: Pre-flight validation check with specific warnings

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-001 | Unit | P0 | ExportValidator identifies missing required fields | Pure validation logic | DATA-001 |
| 3.12-UNIT-002 | Unit | P0 | ExportValidator categorizes issues by severity (error/warning/info) | Severity logic validation | BUS-001 |
| 3.12-UNIT-003 | Unit | P1 | ValidationResult model correctly aggregates multiple validation issues | Data structure verification | TECH-001 |
| 3.12-INT-001 | Integration | P0 | Pre-flight check runs before CSV generation | Workflow validation | DATA-001 |
| 3.12-INT-002 | Integration | P1 | Validation dialog displays categorized warnings | UI integration | BUS-001 |
| 3.12-E2E-001 | E2E | P0 | User sees validation warnings before export | Critical user journey | DATA-001, BUS-001 |

### AC2: Field format validation (dates, amounts)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-004 | Unit | P0 | DateFormatValidator detects invalid date formats | Format validation logic | DATA-001 |
| 3.12-UNIT-005 | Unit | P0 | DateFormatValidator converts MM/DD/YYYY to DD/MM/YYYY correctly | Conversion logic | DATA-003 |
| 3.12-UNIT-006 | Unit | P0 | AmountFormatValidator rejects negative amounts | Business rule validation | DATA-001 |
| 3.12-UNIT-007 | Unit | P0 | AmountFormatValidator enforces two decimal places | Format compliance | DATA-001 |
| 3.12-UNIT-008 | Unit | P0 | TaxAmountValidator ensures tax <= total | Business logic validation | DATA-001 |
| 3.12-UNIT-009 | Unit | P1 | MerchantNameValidator detects CSV injection patterns | Security validation | SEC-001 |
| 3.12-UNIT-010 | Unit | P0 | QuickBooks format validator applies MM/DD/YYYY date requirement | Format-specific logic | DATA-001 |
| 3.12-UNIT-011 | Unit | P0 | Xero format validator applies DD/MM/YYYY date requirement | Format-specific logic | DATA-001 |
| 3.12-INT-003 | Integration | P0 | Format validators work with actual receipt data | Real data validation | DATA-001 |
| 3.12-E2E-002 | E2E | P1 | Export with format issues shows appropriate warnings | User experience validation | BUS-001 |

### AC3: Required field verification

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-012 | Unit | P0 | Validator identifies missing merchant name | Required field logic | DATA-001 |
| 3.12-UNIT-013 | Unit | P0 | Validator identifies missing date | Required field logic | DATA-001 |
| 3.12-UNIT-014 | Unit | P0 | Validator identifies missing total amount | Required field logic | DATA-001 |
| 3.12-UNIT-015 | Unit | P1 | Xero validator checks for ContactName (required) | Format-specific requirement | DATA-001 |
| 3.12-INT-004 | Integration | P0 | Required field check prevents export | Workflow enforcement | DATA-001 |

### AC4: Success confirmation with file location

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-016 | Unit | P2 | ExportSuccessDialog displays correct file path | Display logic | - |
| 3.12-UNIT-017 | Unit | P2 | Copy-to-clipboard functionality works | Utility function | - |
| 3.12-INT-005 | Integration | P1 | ShareService correctly handles file sharing | System integration | - |
| 3.12-INT-006 | Integration | P2 | Success dialog shows validation summary when warnings bypassed | State management | BUS-001 |
| 3.12-E2E-003 | E2E | P1 | User can share exported file from success dialog | Complete workflow | - |

### AC5: Error handling for edge cases

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-018 | Unit | P1 | Handle empty receipt list gracefully | Edge case handling | DATA-002 |
| 3.12-UNIT-019 | Unit | P0 | Handle corrupted receipt data without crashing | Error recovery | DATA-002 |
| 3.12-UNIT-020 | Unit | P1 | Timeout mechanism triggers at 500+ receipts | Performance boundary | PERF-001 |
| 3.12-INT-007 | Integration | P0 | File system permission validation before export | System interaction | SEC-002 |
| 3.12-INT-008 | Integration | P1 | Storage full scenario shows clear error | System boundary | OPS-001 |
| 3.12-INT-009 | Integration | P1 | Retry mechanism works for transient failures | Resilience | DATA-002 |
| 3.12-E2E-004 | E2E | P0 | Large dataset (1000+ receipts) exports successfully | Performance validation | PERF-001 |

### AC6: Validation report before export

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-021 | Unit | P1 | ValidationReportDialog correctly groups issues by severity | Display logic | BUS-001 |
| 3.12-UNIT-022 | Unit | P2 | Scrollable content handles long validation reports | UI component | PERF-003 |
| 3.12-INT-010 | Integration | P0 | Export blocked when critical errors exist | Workflow enforcement | DATA-001 |
| 3.12-INT-011 | Integration | P1 | "Export Anyway" enabled only for warnings (not errors) | Business rule | BUS-001 |
| 3.12-INT-012 | Integration | P2 | Validation results included in export metadata | Data tracking | OPS-002 |
| 3.12-E2E-005 | E2E | P0 | User can fix issues and re-validate | Error recovery workflow | BUS-001 |

## Security Test Scenarios (Additional)

| ID | Level | Priority | Test | Justification | Mitigates Risks |
|----|-------|----------|------|---------------|-----------------|
| 3.12-UNIT-023 | Unit | P0 | Detect all OWASP CSV injection patterns | Security validation | SEC-001 |
| 3.12-UNIT-024 | Unit | P0 | Path traversal prevention in file operations | Security validation | SEC-002 |
| 3.12-E2E-006 | E2E | P0 | Malicious data cannot bypass validation | End-to-end security | SEC-001 |

## Test Data Requirements

### Unit Test Data
- **Valid receipts**: 10 samples with all fields correct
- **Invalid dates**: Various formats (YYYY-MM-DD, DD.MM.YYYY, invalid dates)
- **Invalid amounts**: Negative, too many decimals, non-numeric
- **CSV injection payloads**: =cmd, +macro, -formula, @remote, |pipe
- **Edge cases**: Empty strings, null values, very long strings

### Integration Test Data
- **Receipt collections**: 0, 1, 100, 500, 1000+ receipts
- **Mixed validity**: Collections with various validation issues
- **Format-specific**: QuickBooks and Xero sample data
- **File system states**: Read-only, full disk, no permissions

### E2E Test Data
- **Real-world exports**: Actual receipt data from production-like scenarios
- **Accounting software samples**: Known-good imports for QB/Xero
- **User journeys**: Complete workflows with various decision paths

## Risk Coverage Matrix

| Risk ID | Test Coverage | Test IDs |
|---------|--------------|----------|
| DATA-001 | High | 3.12-UNIT-001,004-011,012-015, 3.12-INT-001,003,004, 3.12-E2E-001 |
| SEC-001 | High | 3.12-UNIT-009,023,024, 3.12-E2E-006 |
| PERF-001 | Medium | 3.12-UNIT-020, 3.12-E2E-004 |
| TECH-001 | Medium | 3.12-UNIT-003, 3.12-INT-006 |
| BUS-001 | High | 3.12-UNIT-002,021, 3.12-INT-002,011, 3.12-E2E-001,002,005 |
| DATA-002 | Medium | 3.12-UNIT-018,019, 3.12-INT-009 |

## Recommended Execution Order

### Phase 1: Critical Path (Must Pass)
1. **P0 Unit tests** (13 tests) - Run first for fast feedback
   - Validation rules
   - Security checks
   - Required fields
2. **P0 Integration tests** (4 tests) - Verify workflows
   - Pre-flight validation
   - Export blocking
   - Permission checks
3. **P0 E2E tests** (3 tests) - Validate user journeys
   - Validation warnings display
   - Large dataset handling
   - Security bypass prevention

### Phase 2: Core Functionality (Should Pass)
4. **P1 Unit tests** (7 tests) - Extended validation
5. **P1 Integration tests** (5 tests) - Component interactions
6. **P1 E2E tests** (2 tests) - Additional workflows

### Phase 3: Nice to Have (Time Permitting)
7. **P2 tests** (9 tests) - UI polish, edge cases

## Test Automation Strategy

### Unit Tests (24 tests)
- **Framework**: Flutter test with mockito
- **Location**: test/unit/domain/services/
- **Execution time**: <5 seconds total
- **CI/CD**: Run on every commit

### Integration Tests (12 tests)
- **Framework**: Flutter integration test
- **Location**: test/integration/
- **Execution time**: <30 seconds total
- **CI/CD**: Run on PR and before merge

### E2E Tests (6 tests)
- **Framework**: Flutter integration test
- **Location**: test/e2e/
- **Execution time**: <2 minutes total
- **CI/CD**: Run before release

## Coverage Metrics

### Code Coverage Targets
- ExportValidator service: 95%
- Format validators: 100%
- UI components: 80%
- Integration points: 90%

### Requirements Coverage
- All 6 acceptance criteria: ✓ Covered
- All critical risks: ✓ Covered
- All high risks: ✓ Covered
- Medium risks: Partial coverage (monitoring gaps accepted)

## Testing Anti-Patterns to Avoid

1. **Don't test the framework** - Trust Flutter/Riverpod
2. **Don't duplicate tests** - Test at one appropriate level
3. **Don't test implementation details** - Focus on behavior
4. **Don't ignore flaky tests** - Fix or remove them
5. **Don't skip security tests** - CSV injection is real

## Success Criteria

Testing is successful when:
- All P0 tests pass (100%)
- P1 tests pass (>95%)
- No critical or high-risk issues remain
- Performance targets met (<500ms for 100 receipts)
- Security tests detect all known patterns
- Real QuickBooks/Xero imports succeed

## Notes for Development Team

### Test-First Opportunities
1. Write validation rule unit tests before implementing validators
2. Create security test suite before validation engine
3. Define performance benchmarks before optimization

### Testing Dependencies
1. Need actual QuickBooks/Xero test accounts
2. Require large dataset generator for performance tests
3. Security test payload library needed

### Continuous Testing
1. Run unit tests in watch mode during development
2. Integration tests before each commit
3. E2E tests in staging environment
4. Performance profiling on every build