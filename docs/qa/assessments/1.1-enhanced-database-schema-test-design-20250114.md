# Test Design: Story 1.1 - Enhanced Database Schema with Categories & Tags

Date: 2025-09-14
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 8 (33%)
- Integration tests: 12 (50%)
- E2E tests: 4 (17%)
- P0 Priority: 10 (42%)
- P1 Priority: 8 (33%)
- P2 Priority: 6 (25%)

## Risk Mitigation Coverage

- DATA-001 (Critical): 4 tests specifically address migration safety
- SEC-001 (High): 3 tests validate RLS policies
- PERF-001 (High): 2 tests verify index performance

## Test Scenarios by Acceptance Criteria

### AC1: Enhanced Receipts Table

#### 1.1-INT-001: Receipt Table Structure Validation
- **Priority**: P0
- **Level**: Integration
- **Description**: Verify all fields exist with correct types after migration
- **Justification**: Database structure is foundational
- **Mitigates**: DATA-001, TECH-001
- **Test Data**: Schema inspection queries

#### 1.1-UNIT-001: Currency Validation Constraint
- **Priority**: P1
- **Level**: Unit
- **Description**: Test 3-letter ISO currency code validation
- **Justification**: Business logic validation
- **Test Cases**:
  - Valid: USD, EUR, GBP
  - Invalid: US, DOLLAR, 1234

#### 1.1-UNIT-002: Positive Amount Constraint
- **Priority**: P0
- **Level**: Unit
- **Description**: Verify amounts cannot be negative
- **Justification**: Data integrity rule
- **Test Cases**:
  - Valid: 0.00, 0.01, 999999.99
  - Invalid: -0.01, -100.00

#### 1.1-INT-002: Tags Array Operations
- **Priority**: P1
- **Level**: Integration
- **Description**: Test TEXT[] array operations for tags
- **Justification**: Complex data type requires DB testing
- **Operations**: Insert, update, query with @> operator

### AC2: Categories Table

#### 1.1-INT-003: Categories Table Creation
- **Priority**: P0
- **Level**: Integration
- **Description**: Verify categories table structure and constraints
- **Justification**: Core feature dependency
- **Mitigates**: DATA-001

#### 1.1-UNIT-003: Hex Color Validation
- **Priority**: P2
- **Level**: Unit
- **Description**: Validate 7-character hex color codes
- **Test Cases**:
  - Valid: #FFFFFF, #000000, #3B82F6
  - Invalid: #FFF, FFFFFF, #GGGGGG

#### 1.1-INT-004: User-Category Unique Constraint
- **Priority**: P0
- **Level**: Integration
- **Description**: Test unique(user_id, name) constraint
- **Justification**: Prevents duplicate categories per user
- **Test**: Insert duplicate, verify rejection

### AC3: Performance Indexes

#### 1.1-INT-005: Date-Based Query Performance
- **Priority**: P0
- **Level**: Integration
- **Description**: Test idx_receipts_user_date performance
- **Justification**: Critical for receipt listing
- **Mitigates**: PERF-001
- **Test**: Query 10K receipts, measure <100ms response

#### 1.1-INT-006: GIN Index Tag Search
- **Priority**: P1
- **Level**: Integration
- **Description**: Test tag array search performance
- **Justification**: Complex index type
- **Mitigates**: PERF-001
- **Test**: Search tags in 10K receipts

#### 1.1-UNIT-004: Index Creation Verification
- **Priority**: P1
- **Level**: Unit
- **Description**: Verify all indexes created
- **Query**: pg_indexes system catalog

### AC4: Row Level Security

#### 1.1-INT-007: RLS User Isolation - Receipts
- **Priority**: P0
- **Level**: Integration
- **Description**: Verify users can only see own receipts
- **Justification**: Critical security requirement
- **Mitigates**: SEC-001
- **Test**: Create 2 users, verify isolation

#### 1.1-INT-008: RLS User Isolation - Categories
- **Priority**: P0
- **Level**: Integration
- **Description**: Verify users can only see own categories
- **Mitigates**: SEC-001
- **Test**: Cross-user category access attempt

#### 1.1-E2E-001: RLS with Supabase Auth
- **Priority**: P0
- **Level**: E2E
- **Description**: Test RLS with real Supabase authentication
- **Justification**: Production security validation
- **Mitigates**: SEC-001
- **Test**: Full auth flow with data access

### AC5: Auto-Update Trigger

#### 1.1-INT-009: Updated_at Trigger Function
- **Priority**: P2
- **Level**: Integration
- **Description**: Verify updated_at changes on UPDATE
- **Justification**: Audit trail requirement
- **Test**: Update receipt, check timestamp

#### 1.1-UNIT-005: Trigger Creation Validation
- **Priority**: P2
- **Level**: Unit
- **Description**: Verify trigger exists in pg_trigger
- **Query**: System catalog verification

## Data Migration Tests

#### 1.1-INT-010: Existing Data Preservation
- **Priority**: P0
- **Level**: Integration
- **Description**: Verify no data loss during migration
- **Justification**: Critical data integrity
- **Mitigates**: DATA-001
- **Test**: Count records before/after, verify content

#### 1.1-INT-011: Migration Rollback
- **Priority**: P0
- **Level**: Integration
- **Description**: Test migration rollback procedure
- **Mitigates**: DATA-001
- **Test**: Apply, rollback, verify original state

#### 1.1-E2E-002: Production Migration Simulation
- **Priority**: P0
- **Level**: E2E
- **Description**: Full migration on production copy
- **Justification**: Real-world validation
- **Mitigates**: DATA-001, OPS-001

## Edge Cases & Error Conditions

#### 1.1-UNIT-006: NULL Value Handling
- **Priority**: P2
- **Level**: Unit
- **Description**: Test NULL in optional fields
- **Fields**: tax_amount, tip_amount, notes

#### 1.1-UNIT-007: Maximum Value Tests
- **Priority**: P2
- **Level**: Unit
- **Description**: Test DECIMAL(10,2) limits
- **Test**: 99999999.99 maximum value

#### 1.1-INT-012: Cascade Delete Behavior
- **Priority**: P1
- **Level**: Integration
- **Description**: Test user deletion cascades
- **Justification**: Data cleanup requirement
- **Test**: Delete user, verify receipts removed

## Performance Benchmarks

#### 1.1-E2E-003: Load Test with Realistic Data
- **Priority**: P1
- **Level**: E2E
- **Description**: Performance test with 100K receipts
- **Benchmarks**:
  - List receipts: <200ms
  - Search by vendor: <150ms
  - Filter by tags: <300ms

#### 1.1-E2E-004: Concurrent User Testing
- **Priority**: P2
- **Level**: E2E
- **Description**: Test with 50 concurrent users
- **Justification**: Multi-tenant performance

## Test Execution Strategy

### Phase 1: Pre-Migration (Unit Tests)
Run all unit tests to validate constraints and logic:
- 1.1-UNIT-001 through 1.1-UNIT-007
- Estimated time: 30 minutes

### Phase 2: Migration Testing (Integration)
Test migration safety and structure:
- 1.1-INT-010, 1.1-INT-011 (Critical for DATA-001)
- 1.1-INT-001, 1.1-INT-003
- Estimated time: 1 hour

### Phase 3: Feature Testing (Integration)
Validate all features work correctly:
- 1.1-INT-002, 1.1-INT-004 through 1.1-INT-009, 1.1-INT-012
- Estimated time: 2 hours

### Phase 4: Security & Performance (E2E)
Production-ready validation:
- 1.1-E2E-001 (Security)
- 1.1-E2E-002 (Migration)
- 1.1-E2E-003, 1.1-E2E-004 (Performance)
- Estimated time: 2 hours

## Test Data Requirements

### Migration Test Data
- Copy of production receipts table (anonymized)
- At least 1000 existing records
- Various date ranges and amounts

### Security Test Data
- 3 test users with different data
- Cross-user test scenarios
- Invalid auth tokens

### Performance Test Data
- 100K receipt records
- 50 categories per user
- 10K unique tags

## Success Criteria

All P0 tests must pass before production deployment:
- Data migration preserves all records
- RLS policies prevent cross-user access
- Performance meets benchmarks
- No constraint violations

## Test Automation Recommendations

### Immediate Automation (P0)
- Migration verification scripts
- RLS security tests
- Constraint validation

### Future Automation (P1-P2)
- Performance benchmarks
- Load testing scenarios
- Edge case validations

---

Test design document: docs/qa/assessments/1.1-enhanced-database-schema-test-design-20250114.md