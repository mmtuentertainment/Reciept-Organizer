<poml>
  <document>
    <title>Test Design: Story 2.4 - Image Reference During Editing</title>
    <type>test-design</type>
    <date>2025-01-06</date>
    <designer>Quinn (Test Architect)</designer>
  </document>

  <test_strategy_overview>
    <total_scenarios>47</total_scenarios>
    <unit_tests>21</unit_tests>
    <unit_percentage>45%</unit_percentage>
    <integration_tests>19</integration_tests>
    <integration_percentage>40%</integration_percentage>
    <e2e_tests>7</e2e_tests>
    <e2e_percentage>15%</e2e_percentage>
    <priority_distribution>
      <p0>12</p0>
      <p1>20</p1>
      <p2>15</p2>
    </priority_distribution>
  </test_strategy_overview>

  <test_scenarios_by_acceptance_criteria>
    <acceptance_criterion id="1">
      <description>Zoomable image alongside fields</description>
      
      <scenario id="2.4-UNIT-001">
        <level>Unit</level>
        <priority>P1</priority>
        <test>ZoomableImageViewer widget renders correctly</test>
        <justification>Widget structure validation, pure component test</justification>
        <given>Valid image path provided</given>
        <when>Widget is rendered</when>
        <then>Image displays with default zoom level</then>
      </scenario>

      <scenario id="2.4-UNIT-002">
        <level>Unit</level>
        <priority>P0</priority>
        <test>Image path validation with SecurityManager</test>
        <justification>Security-critical path validation logic</justification>
        <given>Various file paths including malicious ones</given>
        <when>Path validation is performed</when>
        <then>Only valid paths are accepted</then>
        <mitigates_risks>DATA-001</mitigates_risks>
      </scenario>

      <scenario id="2.4-INT-001">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Image loads from Receipt model imageUri</test>
        <justification>Tests integration with data model and file system</justification>
        <given>Receipt with valid imageUri</given>
        <when>ZoomableImageViewer loads the image</when>
        <then>Image displays correctly from file system</then>
      </scenario>

      <scenario id="2.4-INT-002">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Split-screen layout adapts to screen size</test>
        <justification>Layout builder integration with responsive breakpoints</justification>
        <given>Different screen sizes (phone, tablet)</given>
        <when>Layout is rendered</when>
        <then>Appropriate layout (stacked vs split) is shown</then>
        <mitigates_risks>OPS-001</mitigates_risks>
      </scenario>

      <scenario id="2.4-E2E-001">
        <level>E2E</level>
        <priority>P1</priority>
        <test>User can view receipt image while editing fields</test>
        <justification>Core user journey validation</justification>
        <given>User on receipt editing screen</given>
        <when>Image viewer is displayed</when>
        <then>User can see image and edit fields simultaneously</then>
      </scenario>
    </acceptance_criterion>

    <acceptance_criterion id="2">
      <description>Pinch-to-zoom gesture support</description>
      
      <scenario id="2.4-UNIT-003">
        <level>Unit</level>
        <priority>P0</priority>
        <test>Zoom level constraints enforcement (0.5x-5x)</test>
        <justification>Pure logic for zoom boundary validation</justification>
        <given>Various zoom levels</given>
        <when>Zoom is applied</when>
        <then>Zoom stays within 0.5x to 5x bounds</then>
      </scenario>

      <scenario id="2.4-UNIT-004">
        <level>Unit</level>
        <priority>P1</priority>
        <test>Zoom state management in provider</test>
        <justification>State logic testing without UI dependencies</justification>
        <given>ImageViewerProvider with initial state</given>
        <when>Zoom actions are dispatched</when>
        <then>State updates correctly</then>
      </scenario>

      <scenario id="2.4-INT-003">
        <level>Integration</level>
        <priority>P0</priority>
        <test>Pinch gesture updates zoom level</test>
        <justification>Gesture detector integration with state</justification>
        <given>Image displayed at default zoom</given>
        <when>Pinch gesture is performed</when>
        <then>Image zooms proportionally</then>
        <mitigates_risks>PERF-001</mitigates_risks>
      </scenario>

      <scenario id="2.4-INT-004">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Double-tap zoom animation</test>
        <justification>Animation controller integration</justification>
        <given>Image at any zoom level</given>
        <when>Double-tap gesture occurs</when>
        <then>Smooth zoom animation to preset level</then>
      </scenario>

      <scenario id="2.4-E2E-002">
        <level>E2E</level>
        <priority>P1</priority>
        <test>Platform-specific gesture behavior (iOS vs Android)</test>
        <justification>Cross-platform user experience validation</justification>
        <given>App on iOS and Android devices</given>
        <when>Pinch-to-zoom is performed</when>
        <then>Gesture works consistently on both platforms</then>
        <mitigates_risks>TECH-004</mitigates_risks>
      </scenario>
    </acceptance_criterion>

    <acceptance_criterion id="3">
      <description>Pan capability for large receipts</description>
      
      <scenario id="2.4-UNIT-005">
        <level>Unit</level>
        <priority>P1</priority>
        <test>Pan boundary calculation logic</test>
        <justification>Pure mathematical boundary calculations</justification>
        <given>Image dimensions and zoom level</given>
        <when>Pan boundaries are calculated</when>
        <then>Correct viewport constraints returned</then>
      </scenario>

      <scenario id="2.4-UNIT-006">
        <level>Unit</level>
        <priority>P1</priority>
        <test>Pan state tracking in provider</test>
        <justification>State management logic validation</justification>
        <given>Current pan position</given>
        <when>Pan updates occur</when>
        <then>Position tracked accurately</then>
      </scenario>

      <scenario id="2.4-INT-005">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Pan gesture with boundary constraints</test>
        <justification>Gesture handling with viewport limits</justification>
        <given>Zoomed image larger than viewport</given>
        <when>User pans the image</when>
        <then>Pan stops at image boundaries</then>
      </scenario>

      <scenario id="2.4-INT-006">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Gesture conflict resolution with scroll</test>
        <justification>Complex gesture arena management</justification>
        <given>Image in scrollable container</given>
        <when>Pan gesture occurs</when>
        <then>Correct gesture wins based on direction</then>
        <mitigates_risks>TECH-001</mitigates_risks>
      </scenario>

      <scenario id="2.4-PERF-001">
        <level>Integration</level>
        <priority>P0</priority>
        <test>Pan gesture performance with large images</test>
        <justification>Performance validation under load</justification>
        <given>10MB image fully zoomed</given>
        <when>Continuous pan gestures performed</when>
        <then>60 FPS maintained throughout</then>
        <mitigates_risks>PERF-001</mitigates_risks>
      </scenario>
    </acceptance_criterion>

    <acceptance_criterion id="4">
      <description>Toggle between image and fields view</description>
      
      <scenario id="2.4-UNIT-007">
        <level>Unit</level>
        <priority>P2</priority>
        <test>View mode state management</test>
        <justification>Simple state toggle logic</justification>
        <given>Current view mode</given>
        <when>Toggle action dispatched</when>
        <then>Mode switches correctly</then>
      </scenario>

      <scenario id="2.4-INT-007">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Layout transition between modes</test>
        <justification>UI state preservation during layout change</justification>
        <given>Split view with specific zoom/pan</given>
        <when>Toggle to image-only mode</when>
        <then>Zoom/pan state preserved</then>
        <mitigates_risks>TECH-003</mitigates_risks>
      </scenario>

      <scenario id="2.4-INT-008">
        <level>Integration</level>
        <priority>P2</priority>
        <test>Toggle button visibility and state</test>
        <justification>UI component integration</justification>
        <given>View in either mode</given>
        <when>Screen renders</when>
        <then>Toggle button shows correct state</then>
      </scenario>

      <scenario id="2.4-E2E-003">
        <level>E2E</level>
        <priority>P2</priority>
        <test>User workflow switching between views</test>
        <justification>Complete user interaction flow</justification>
        <given>User editing receipt</given>
        <when>Toggling between view modes</when>
        <then>Seamless transition maintaining context</then>
      </scenario>
    </acceptance_criterion>

    <acceptance_criterion id="5">
      <description>Highlight OCR bounding boxes on image</description>
      
      <scenario id="2.4-UNIT-008">
        <level>Unit</level>
        <priority>P1</priority>
        <test>Bounding box coordinate transformation</test>
        <justification>Pure mathematical transformation logic</justification>
        <given>OCR coordinates and image dimensions</given>
        <when>Transformation applied</when>
        <then>Correct display coordinates calculated</then>
        <mitigates_risks>TECH-002</mitigates_risks>
      </scenario>

      <scenario id="2.4-UNIT-009">
        <level>Unit</level>
        <priority>P1</priority>
        <test>Confidence-based color calculation</test>
        <justification>Color mapping logic validation</justification>
        <given>Confidence scores</given>
        <when>Colors are determined</when>
        <then>Green (>90%), Yellow (75-90%), Red (<75%)</then>
      </scenario>

      <scenario id="2.4-UNIT-010">
        <level>Unit</level>
        <priority>P2</priority>
        <test>Custom painter rendering logic</test>
        <justification>Drawing logic without dependencies</justification>
        <given>Bounding box data</given>
        <when>Paint method called</when>
        <then>Correct shapes drawn</then>
      </scenario>

      <scenario id="2.4-INT-009">
        <level>Integration</level>
        <priority>P1</priority>
        <test>Bounding box overlay scales with zoom</test>
        <justification>Overlay integration with zoom state</justification>
        <given>Bounding boxes displayed</given>
        <when>Image is zoomed</when>
        <then>Boxes scale proportionally</then>
      </scenario>

      <scenario id="2.4-INT-010">
        <level>Integration</level>
        <priority>P2</priority>
        <test>Bounding box tap to focus field</test>
        <justification>Touch interaction with field focusing</justification>
        <given>Bounding boxes visible</given>
        <when>User taps a box</when>
        <then>Corresponding field gains focus</then>
      </scenario>

      <scenario id="2.4-INT-011">
        <level>Integration</level>
        <priority>P2</priority>
        <test>Handle missing bounding box data</test>
        <justification>Graceful degradation when OCR lacks data</justification>
        <given>ProcessingResult without bounding boxes</given>
        <when>Overlay attempts to render</when>
        <then>No overlay shown, no errors</then>
      </scenario>
    </acceptance_criterion>
  </test_scenarios_by_acceptance_criteria>

  <performance_test_scenarios>
    <scenario id="2.4-PERF-002">
      <level>Integration</level>
      <priority>P0</priority>
      <test>Memory usage during image manipulation</test>
      <justification>Critical performance validation</justification>
      <given>Multiple large images loaded</given>
      <when>Switching between receipts</when>
      <then>Memory properly released, no leaks</then>
      <mitigates_risks>PERF-002</mitigates_risks>
    </scenario>

    <scenario id="2.4-PERF-003">
      <level>Integration</level>
      <priority>P0</priority>
      <test>Gesture response time measurement</test>
      <justification>Touch latency validation</justification>
      <given>Image viewer active</given>
      <when>Touch gestures performed</when>
      <then>Response time < 16ms</then>
      <mitigates_risks>PERF-001</mitigates_risks>
    </scenario>

    <scenario id="2.4-PERF-004">
      <level>Integration</level>
      <priority>P1</priority>
      <test>RepaintBoundary effectiveness</test>
      <justification>Performance optimization validation</justification>
      <given>Complex UI with image viewer</given>
      <when>Image manipulated</when>
      <then>Only image widget repaints</then>
    </scenario>
  </performance_test_scenarios>

  <error_handling_scenarios>
    <scenario id="2.4-ERR-001">
      <level>Integration</level>
      <priority>P0</priority>
      <test>Handle corrupt image files</test>
      <justification>Error recovery validation</justification>
      <given>Corrupt or invalid image file</given>
      <when>Image load attempted</when>
      <then>Error UI shown, app doesn't crash</then>
    </scenario>

    <scenario id="2.4-ERR-002">
      <level>Unit</level>
      <priority>P1</priority>
      <test>Handle missing image files</test>
      <justification>Common error scenario</justification>
      <given>Receipt with non-existent imageUri</given>
      <when>Image requested</when>
      <then>Placeholder shown with error message</then>
    </scenario>

    <scenario id="2.4-ERR-003">
      <level>Integration</level>
      <priority>P1</priority>
      <test>Handle permission denied errors</test>
      <justification>Security error handling</justification>
      <given>Image in restricted location</given>
      <when>Access attempted</when>
      <then>Security error handled gracefully</then>
      <mitigates_risks>DATA-001</mitigates_risks>
    </scenario>
  </error_handling_scenarios>

  <accessibility_test_scenarios>
    <scenario id="2.4-A11Y-001">
      <level>Integration</level>
      <priority>P2</priority>
      <test>Screen reader announces image state</test>
      <justification>Accessibility compliance</justification>
      <given>Screen reader active</given>
      <when>Image viewer focused</when>
      <then>Zoom level and position announced</then>
    </scenario>

    <scenario id="2.4-A11Y-002">
      <level>Integration</level>
      <priority>P2</priority>
      <test>Keyboard navigation support</test>
      <justification>Accessibility for non-touch users</justification>
      <given>Keyboard user</given>
      <when>Navigating image viewer</when>
      <then>Can zoom/pan with keyboard</then>
    </scenario>
  </accessibility_test_scenarios>

  <state_management_scenarios>
    <scenario id="2.4-STATE-001">
      <level>Unit</level>
      <priority>P1</priority>
      <test>Provider disposal prevents memory leaks</test>
      <justification>Memory management validation</justification>
      <given>ImageViewerProvider instance</given>
      <when>Screen disposed</when>
      <then>All controllers and listeners cleaned up</then>
      <mitigates_risks>PERF-002</mitigates_risks>
    </scenario>

    <scenario id="2.4-STATE-002">
      <level>Integration</level>
      <priority>P1</priority>
      <test>State persistence across app lifecycle</test>
      <justification>User experience continuity</justification>
      <given>App goes to background</given>
      <when>App returns to foreground</when>
      <then>Image state restored</then>
    </scenario>

    <scenario id="2.4-STATE-003">
      <level>Integration</level>
      <priority>P2</priority>
      <test>Preference persistence for defaults</test>
      <justification>User preference handling</justification>
      <given>User sets default zoom preference</given>
      <when>New image opened</when>
      <then>Preferred zoom applied</then>
    </scenario>
  </state_management_scenarios>

  <cross_platform_scenarios>
    <scenario id="2.4-CROSS-001">
      <level>E2E</level>
      <priority>P1</priority>
      <test>iOS specific gesture handling</test>
      <justification>Platform-specific validation</justification>
      <given>iOS device</given>
      <when>All gestures performed</when>
      <then>Natural iOS behavior maintained</then>
    </scenario>

    <scenario id="2.4-CROSS-002">
      <level>E2E</level>
      <priority>P1</priority>
      <test>Android specific gesture handling</test>
      <justification>Platform-specific validation</justification>
      <given>Android device</given>
      <when>All gestures performed</when>
      <then>Natural Android behavior maintained</then>
    </scenario>

    <scenario id="2.4-CROSS-003">
      <level>E2E</level>
      <priority>P2</priority>
      <test>Tablet vs phone layout validation</test>
      <justification>Form factor adaptation</justification>
      <given>Various device sizes</given>
      <when>App runs on each</when>
      <then>Appropriate layout rendered</then>
    </scenario>
  </cross_platform_scenarios>

  <risk_coverage_mapping>
    <risk id="PERF-001">
      <covered_by>
        <test>2.4-INT-003</test>
        <test>2.4-PERF-001</test>
        <test>2.4-PERF-003</test>
      </covered_by>
    </risk>
    
    <risk id="PERF-002">
      <covered_by>
        <test>2.4-PERF-002</test>
        <test>2.4-STATE-001</test>
      </covered_by>
    </risk>
    
    <risk id="TECH-001">
      <covered_by>
        <test>2.4-INT-006</test>
      </covered_by>
    </risk>
    
    <risk id="TECH-002">
      <covered_by>
        <test>2.4-UNIT-008</test>
      </covered_by>
    </risk>
    
    <risk id="TECH-003">
      <covered_by>
        <test>2.4-INT-007</test>
      </covered_by>
    </risk>
    
    <risk id="TECH-004">
      <covered_by>
        <test>2.4-E2E-002</test>
      </covered_by>
    </risk>
    
    <risk id="DATA-001">
      <covered_by>
        <test>2.4-UNIT-002</test>
        <test>2.4-ERR-003</test>
      </covered_by>
    </risk>
    
    <risk id="OPS-001">
      <covered_by>
        <test>2.4-INT-002</test>
      </covered_by>
    </risk>
  </risk_coverage_mapping>

  <recommended_execution_order>
    <phase number="1">
      <name>P0 Unit Tests (Fail Fast)</name>
      <tests>
        <test>2.4-UNIT-002 (Security validation)</test>
        <test>2.4-UNIT-003 (Zoom constraints)</test>
      </tests>
    </phase>
    
    <phase number="2">
      <name>P0 Integration Tests</name>
      <tests>
        <test>2.4-INT-003 (Pinch zoom performance)</test>
        <test>2.4-PERF-001 (Pan performance)</test>
        <test>2.4-PERF-002 (Memory management)</test>
        <test>2.4-PERF-003 (Gesture response time)</test>
        <test>2.4-ERR-001 (Corrupt image handling)</test>
      </tests>
    </phase>
    
    <phase number="3">
      <name>P1 Tests (Core Functionality)</name>
      <tests>
        <test>All P1 unit tests (11 tests)</test>
        <test>All P1 integration tests (8 tests)</test>
        <test>All P1 E2E tests (3 tests)</test>
      </tests>
    </phase>
    
    <phase number="4">
      <name>P2 Tests (Secondary Features)</name>
      <tests>
        <test>All P2 tests (15 tests)</test>
      </tests>
    </phase>
    
    <phase number="5">
      <name>Cross-Platform Validation</name>
      <tests>
        <test>Platform-specific E2E tests</test>
        <test>Device form factor tests</test>
      </tests>
    </phase>
  </recommended_execution_order>

  <test_data_requirements>
    <data_set id="1">
      <name>Test Images</name>
      <requirements>
        <requirement>Small images (< 1MB) for unit tests</requirement>
        <requirement>Medium images (1-5MB) for integration tests</requirement>
        <requirement>Large images (5-10MB) for performance tests</requirement>
        <requirement>Various formats: JPG, PNG, WebP</requirement>
        <requirement>Different aspect ratios: portrait, landscape, square</requirement>
        <requirement>Corrupt image files for error testing</requirement>
      </requirements>
    </data_set>
    
    <data_set id="2">
      <name>OCR Bounding Box Data</name>
      <requirements>
        <requirement>Sample ProcessingResult with bounding boxes</requirement>
        <requirement>Various confidence scores for color testing</requirement>
        <requirement>Missing/null bounding box scenarios</requirement>
      </requirements>
    </data_set>
    
    <data_set id="3">
      <name>Device Configurations</name>
      <requirements>
        <requirement>Phone screen sizes (5"-6.5")</requirement>
        <requirement>Tablet screen sizes (8"-12")</requirement>
        <requirement>Various pixel densities</requirement>
        <requirement>iOS and Android test devices</requirement>
      </requirements>
    </data_set>
  </test_data_requirements>

  <quality_recommendations>
    <recommendation priority="high">
      <title>Implement Performance Monitoring Early</title>
      <description>Add FPS tracking and memory monitoring from the start to catch regressions</description>
    </recommendation>
    
    <recommendation priority="high">
      <title>Create Visual Regression Tests</title>
      <description>Use Flutter golden tests for zoom states and bounding box rendering</description>
    </recommendation>
    
    <recommendation priority="medium">
      <title>Device Lab Testing</title>
      <description>Test on actual low-end devices, not just simulators</description>
    </recommendation>
    
    <recommendation priority="medium">
      <title>Gesture Recording</title>
      <description>Record real user gestures for replay testing</description>
    </recommendation>
  </quality_recommendations>

  <gate_summary>
    <test_design>
      <scenarios_total>47</scenarios_total>
      <by_level>
        <unit>21</unit>
        <integration>19</integration>
        <e2e>7</e2e>
      </by_level>
      <by_priority>
        <p0>12</p0>
        <p1>20</p1>
        <p2>15</p2>
      </by_priority>
      <coverage_gaps>[]</coverage_gaps>
    </test_design>
  </gate_summary>

  <metadata>
    <test_design_location>docs/qa/assessments/2.4-test-design-20250106.md</test_design_location>
    <p0_tests_count>12</p0_tests_count>
    <estimated_test_effort>8-10 person days</estimated_test_effort>
  </metadata>
</poml>