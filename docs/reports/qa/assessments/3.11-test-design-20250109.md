# Test Design: Story 3.11 - Preview CSV Before Export

Date: 2025-01-09
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 7 (39%)
- Integration tests: 6 (33%)
- E2E tests: 3 (17%)
- Performance tests: 1 (5%)
- Security tests: 1 (5%)
- Priority distribution: P0: 12, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Show first 5 rows with headers

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-UNIT-001 | Unit | P0 | CSVPreviewService generates correct 5-row preview with headers | Core preview logic validation | DATA-001 |
| 3.11-INT-001 | Integration | P0 | Preview provider fetches and transforms data correctly | Multi-component data flow validation | DATA-001 |
| 3.11-E2E-001 | E2E | P1 | User sees preview with correct headers and 5 data rows | Critical user journey validation | - |

#### Test Data Requirements
- Empty receipt list
- Single receipt
- Exactly 5 receipts
- More than 5 receipts (10, 100, 1000)
- Receipts with all fields populated
- Receipts with missing optional fields

### AC2: Display total row count

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-UNIT-002 | Unit | P0 | Count calculation accurate for 0, 1, 5, 100+ receipts | Pure calculation logic | DATA-001 |
| 3.11-INT-002 | Integration | P1 | Count updates when date range filter changes | Provider dependency interaction | - |

#### Test Data Requirements
- Various receipt counts to verify accuracy
- Date-filtered subsets

### AC3: Highlight any validation warnings

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-UNIT-003 | Unit | P0 | CSV injection detection for =, +, -, @, tab, CR, LF | Critical security validation | SEC-001 |
| 3.11-UNIT-004 | Unit | P0 | Validation rules identify missing required fields | Business rule validation | - |
| 3.11-INT-003 | Integration | P0 | Warning highlights appear with correct styling in table | UI component integration | SEC-001 |
| 3.11-E2E-002 | E2E | P0 | Security test suite - attempts CSV injection patterns | Critical security validation | SEC-001 |

#### Test Data Requirements
- Malicious payloads: `=cmd|'/c calc'`, `=1+1`, `@SUM(A1:A10)`
- Edge cases: Leading spaces before special chars
- Unicode special characters
- Multi-line content with embedded newlines

### AC4: Scrollable preview table

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-UNIT-005 | Unit | P2 | DataTable renders with horizontal scroll configuration | Widget configuration validation | - |
| 3.11-INT-004 | Integration | P2 | Table scrolls smoothly with wide data (10+ columns) | Performance and usability | PERF-002 |

#### Test Data Requirements
- Narrow screen widths (mobile)
- Wide receipts with long merchant names
- Multiple validation warnings in scrollable area

### AC5: Format applied to preview

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-UNIT-006 | Unit | P0 | QuickBooks format (MM/dd/yyyy dates, specific columns) | Format logic validation | DATA-001 |
| 3.11-UNIT-007 | Unit | P0 | Xero format (dd/MM/yyyy dates, specific columns) | Format logic validation | DATA-001 |
| 3.11-INT-005 | Integration | P0 | Preview updates when format selection changes | Provider interaction validation | TECH-001 |
| 3.11-E2E-003 | E2E | P0 | Preview content matches exported CSV exactly | Critical consistency validation | DATA-001 |

#### Test Data Requirements
- Same data in all three formats
- Date edge cases (leap years, month boundaries)
- Currency formatting variations
- Special characters in merchant names

## Additional Risk-Based Tests

### Performance Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-PERF-001 | Performance | P0 | Preview generates in <100ms for 100 receipts | Explicit requirement validation | PERF-001 |

#### Performance Test Scenarios
- Baseline: 5 receipts
- Typical: 50 receipts  
- Stress: 100 receipts
- Edge: 500 receipts
- Measure: Generation time, render time, memory usage

### Security Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-SEC-001 | Security | P0 | Penetration testing of CSV generation endpoints | Critical security validation | SEC-001 |

#### Security Test Scenarios
- OWASP Top 10 injection patterns
- Buffer overflow attempts
- Path traversal attempts
- XSS through CSV content display

### Memory Management Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 3.11-MEM-001 | Integration | P1 | Widget properly disposes listeners and controllers | Memory leak prevention | TECH-002 |

#### Memory Test Scenarios
- Create/destroy widget 100 times
- Provider subscription cleanup
- Cache memory growth over time

## Risk Coverage Matrix

| Risk ID | Risk Description | Test Coverage |
|---------|------------------|---------------|
| SEC-001 | CSV Injection (Critical) | 3.11-UNIT-003, 3.11-INT-003, 3.11-E2E-002, 3.11-SEC-001 |
| PERF-001 | Preview >100ms (High) | 3.11-PERF-001 |
| DATA-001 | Preview-Export Mismatch (High) | 3.11-UNIT-001, 3.11-UNIT-002, 3.11-UNIT-006, 3.11-UNIT-007, 3.11-E2E-003 |
| TECH-001 | State Race Conditions (Medium) | 3.11-INT-005 |
| TECH-002 | Memory Leaks (Medium) | 3.11-MEM-001 |
| PERF-002 | UI Rendering (Medium) | 3.11-INT-004 |

## Recommended Execution Order

### Phase 1: Critical Security & Data (Must Pass)
1. **3.11-UNIT-003** - CSV injection detection (P0)
2. **3.11-SEC-001** - Penetration testing (P0)
3. **3.11-E2E-002** - Security test suite (P0)
4. **3.11-E2E-003** - Preview-export consistency (P0)

### Phase 2: Core Functionality (Must Pass)
5. **3.11-UNIT-001** - Preview generation logic (P0)
6. **3.11-UNIT-002** - Count calculation (P0)
7. **3.11-UNIT-006** - QuickBooks format (P0)
8. **3.11-UNIT-007** - Xero format (P0)
9. **3.11-PERF-001** - Performance requirement (P0)

### Phase 3: Integration & Flow (Must Pass)
10. **3.11-INT-001** - Provider data flow (P0)
11. **3.11-INT-003** - Warning highlights (P0)
12. **3.11-INT-005** - Format changes (P0)

### Phase 4: User Experience (Should Pass)
13. **3.11-E2E-001** - User journey (P1)
14. **3.11-INT-002** - Date range updates (P1)
15. **3.11-MEM-001** - Memory management (P1)

### Phase 5: Polish (Nice to Have)
16. **3.11-UNIT-005** - Scroll configuration (P2)
17. **3.11-INT-004** - Smooth scrolling (P2)

## Test Data Management

### Required Test Fixtures
1. **Valid receipts** - Various formats and completeness
2. **Malicious payloads** - Security test data
3. **Edge cases** - Boundary conditions
4. **Performance datasets** - 5, 50, 100, 500 receipts

### Mock Requirements
- DateRangeProvider mock
- ExportFormatProvider mock
- ReceiptRepository mock with controlled data

## Quality Gates

### Definition of Done
- All P0 tests passing (12 tests)
- Security tests validated by security team
- Performance <100ms verified
- Preview-export consistency proven
- No memory leaks detected

### Exit Criteria
- 100% P0 test pass rate
- 90% P1 test pass rate
- Security sign-off obtained
- Performance benchmarks met
- Code coverage >80% for new code

## Developer Handoff Notes

### Key Testing Focus Areas
1. **Security is paramount** - Test CSV injection thoroughly
2. **Performance is explicit** - Must meet 100ms target
3. **Consistency is critical** - Preview must match export exactly
4. **State management** - Test provider interactions carefully

### Suggested Testing Tools
- Flutter test framework for unit/widget tests
- Integration test package for E2E tests
- Mockito for mocking dependencies
- Flutter DevTools for performance profiling
- OWASP ZAP for security testing

### Common Pitfalls to Avoid
1. Don't test the same logic at multiple levels
2. Don't skip security tests "because it's just a preview"
3. Don't ignore performance until the end
4. Don't forget to test error conditions
5. Don't assume sanitization works - verify it