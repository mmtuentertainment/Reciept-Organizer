# Story 3.11: Preview CSV Before Export

## Status
Ready for Done

## Story
**As a** Mike (Freelance Contractor),
**I want** to preview CSV before export,
**so that** I can catch issues before sending to my accountant

## Acceptance Criteria
1. Show first 5 rows with headers
2. Display total row count
3. Highlight any validation warnings
4. Scrollable preview table
5. Format applied to preview

## Tasks / Subtasks
- [x] Task 1: Create CSV Preview Generator Service (AC: 1, 2, 5)
  - [x] Create CSVPreviewService in features/export/domain/services/csv_preview_service.dart
  - [x] Implement generatePreview() method that takes receipts list and format
  - [x] Return first 5 rows of CSV data using existing CSVExportService format logic
  - [x] Calculate and include total row count in preview response
  - [x] Apply selected format (QuickBooks/Xero/Generic) from exportFormatProvider
  - [x] Create unit tests in test/unit/domain/services/csv_preview_service_test.dart

- [x] Task 2: Create CSV Preview Table Widget (AC: 1, 4)
  - [x] Create CSVPreviewTable widget in features/export/presentation/widgets/csv_preview_table.dart
  - [x] Implement responsive DataTable with horizontal scroll capability
  - [x] Display headers as fixed row with proper styling (Material 3 theme)
  - [x] Show first 5 data rows with appropriate cell formatting
  - [x] Add row numbers for reference (1-5)
  - [x] Include "... X more rows" indicator below the table
  - [x] Apply proper Material 3 theming from shared/theme/app_theme.dart
  - [x] Create widget tests in test/widget/features/export/csv_preview_table_test.dart

- [x] Task 3: Implement Validation Highlighting (AC: 3)
  - [x] Create ValidationHighlighter mixin for preview table cells
  - [x] Integrate with existing validation logic from CSVExportService
  - [x] Apply warning color (Theme.of(context).colorScheme.error) to invalid cells
  - [x] Add warning icon (Icons.warning_amber_rounded) to cells with validation issues
  - [x] Display tooltip with specific validation error message on hover/tap
  - [x] Create unit tests for validation highlighting logic

- [x] Task 4: Create CSV Preview Provider (AC: 1, 2, 3, 5)
  - [x] Create csvPreviewProvider using Riverpod AsyncNotifierProvider in features/export/presentation/providers/csv_preview_provider.dart
  - [x] Define CSVPreviewState model with previewData, totalCount, validationWarnings fields
  - [x] Integrate with dateRangeProvider to get filtered receipts
  - [x] Integrate with exportFormatProvider to apply selected format
  - [x] Implement loading and error states using AsyncValue wrapper
  - [x] Auto-refresh preview when date range or format changes
  - [x] Create provider tests in test/unit/features/export/csv_preview_provider_test.dart

- [x] Task 5: Integrate Preview into Export Screen (AC: 1, 2, 3, 4, 5)
  - [x] Add CSVPreviewTable widget to ExportScreen after format selection
  - [x] Position preview section between format selection and export button
  - [x] Show loading indicator while preview generates (CircularProgressIndicator)
  - [x] Display validation summary above preview table if warnings exist
  - [x] Update export button to be disabled if critical validation errors exist
  - [x] Add "Refresh Preview" icon button if needed
  - [x] Ensure preview updates automatically when format or date range changes
  - [x] Create integration tests in test/integration/export_preview_flow_test.dart

- [x] Task 6: Performance Optimization
  - [x] Implement preview caching to avoid regeneration on screen rebuilds
  - [x] Optimize CSV generation for preview (only process first 5 receipts fully)
  - [x] Add performance monitoring for preview generation time
  - [x] Ensure preview generation completes in <100ms as per architecture specs
  - [x] Create performance tests in test/performance/csv_preview_performance_test.dart

## Dev Notes

### Previous Story Insights
From Story 3.10 (CSV Format Options):
- ExportFormat enum already exists in CSVExportService: quickbooks, xero, generic
- Format selection widget and provider already implemented
- Settings persistence pattern established for user preferences
- Performance optimized with database indexing on receiptDate
[Source: Story 3.10 Dev Agent Record]

From Story 3.9 (Date Range Selection):
- Date range picker and provider already implemented
- Receipt filtering by date range working with ReceiptRepository.getReceiptsByDateRange()
- Established pattern for export feature providers and widgets
[Source: Story 3.9 implementation]

### Data Models
Receipt model structure for CSV export [Source: docs/sharded-architecture/data-models.md#4.1]:
- id: String (UUID)
- imageUri: String (local file path)
- capturedAt: DateTime
- ocrResults: ProcessingResult with extracted fields
- status: ReceiptStatus enum
- notes: Optional string field
- version: number for optimistic locking

ProcessingResult fields needed for CSV [Source: docs/sharded-architecture/data-models.md#4.2]:
- merchantName: String with confidence score
- totalAmount: double with confidence score
- date: DateTime with confidence score
- taxAmount: double with confidence score

### API Specifications
No external API calls needed - all processing is local [Source: docs/sharded-architecture/tech-stack.md#backend_layer]

### Component Specifications
Export feature module structure [Source: docs/sharded-architecture/frontend-architecture.md#10.1]:
- features/export/presentation/screens/: Screen components
- features/export/presentation/widgets/: Reusable widgets (CSVPreviewTable goes here)
- features/export/presentation/providers/: Riverpod providers (csvPreviewProvider goes here)
- features/export/domain/services/: Domain services (CSVPreviewService goes here)

State management pattern [Source: docs/sharded-architecture/frontend-architecture.md#10.2]:
- Use Riverpod AsyncNotifierProvider for async state
- Implement loading states with AsyncValue wrapper
- Use copyWith patterns for immutable state updates
- Auto-refresh on dependency changes (date range, format)

### File Locations
Based on project structure [Source: docs/sharded-architecture/source-tree.md]:
- New preview service: apps/mobile/lib/features/export/domain/services/csv_preview_service.dart
- Preview table widget: apps/mobile/lib/features/export/presentation/widgets/csv_preview_table.dart
- Preview provider: apps/mobile/lib/features/export/presentation/providers/csv_preview_provider.dart
- Widget tests: apps/mobile/test/widget/features/export/csv_preview_table_test.dart
- Unit tests: apps/mobile/test/unit/domain/services/csv_preview_service_test.dart
- Provider tests: apps/mobile/test/unit/features/export/csv_preview_provider_test.dart
- Integration tests: apps/mobile/test/integration/export_preview_flow_test.dart

### Testing Requirements
Testing standards from architecture [Source: docs/sharded-architecture/coding-standards.md]:
- All new code must have unit tests
- Widget tests for all UI components
- Integration tests for complete workflows
- Use mockito for mocking dependencies
- Test file naming: {file_name}_test.dart
- Performance tests for operations with targets (<100ms for preview)

Export workflow performance targets [Source: docs/sharded-architecture/core-workflows.md#EXPORT_WORKFLOW_METRICS]:
- CSV generation: <2s for 100 receipts
- Preview accuracy: CSV preview must match final output exactly
- Error clarity: Clear instructions for fixing validation errors

### Technical Constraints
Critical coding rules [Source: docs/sharded-architecture/coding-standards.md#CRITICAL_RULES]:
- Never mutate state directly - use Riverpod notifiers with copyWith
- All service methods must use try-catch and throw typed exceptions
- Dispose all controllers and listeners in widget dispose() methods
- Always validate file paths with SecurityManager before operations

Naming conventions [Source: docs/sharded-architecture/coding-standards.md#NAMING_MATRIX]:
- Widgets: PascalCase (CSVPreviewTable.dart)
- Services: PascalCase with 'Service' suffix (CSVPreviewService.dart)
- Providers: camelCase with 'Provider' suffix (csvPreviewProvider)

Material 3 theming [Source: docs/sharded-architecture/tech-stack.md#ui_system]:
- Use Material 3 design system
- Apply theme from shared/theme/app_theme.dart
- Maintain consistency with existing export UI components

### Security Considerations
CSV generation security [Source: Story 3.10 security requirements]:
- Implement CSV injection prevention for special characters (=, +, -, @, tab, CR, LF)
- Sanitize all user-input fields before CSV generation
- Use existing CSVExportService sanitization methods

### Performance Requirements
From architecture specs [Source: docs/sharded-architecture/core-workflows.md]:
- Preview generation must complete in <100ms
- Only process first 5 receipts fully for preview efficiency
- Implement caching to avoid regeneration on rebuilds

## Testing

### Test File Locations
- Widget tests: apps/mobile/test/widget/features/export/
- Unit tests: apps/mobile/test/unit/domain/services/ and test/unit/features/export/
- Integration tests: apps/mobile/test/integration/
- Performance tests: apps/mobile/test/performance/

### Testing Standards
- Use Flutter test framework with mockito for mocking
- Follow AAA pattern (Arrange, Act, Assert)
- Test both happy path and error cases
- Include edge cases (empty data, malformed data)
- Performance tests must verify <100ms preview generation

### Testing Frameworks
- Flutter test package for widget and unit tests
- Integration test package for end-to-end flows
- Mockito for creating mock dependencies
- Use existing test utilities and fixtures from test/ directory

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation from Epic 3 | Bob (Scrum Master) |
| 2025-01-09 | 1.1 | Applied QA fixes - Added E2E consistency test | James (Developer) |

## Dev Agent Record
### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805) in ULTRA THINK mode

### Debug Log References
- Security implementation: csv_preview_service.dart:168-196
- Performance monitoring: csv_preview_service.dart:97-100
- Cache implementation: csv_preview_service.dart:44-46, 60-71
- Export blocking: export_screen.dart:283-286, 439-459
- QA Fix Applied: Added E2E test for DATA-001 gap (2025-01-09)

### Completion Notes List
- **Critical Requirements Met**:
  - SEC-001: CSV injection prevention implemented with comprehensive detection
  - PERF-001: <100ms target achieved with caching and 5-row limit
  - DATA-001: Preview-export consistency ensured by reusing CSVExportService
- **Security First Approach**: All CSV injection vectors blocked with critical severity warnings
- **Performance Optimized**: Cache mechanism, preview limiting, performance monitoring
- **Test Coverage**: 41 tests created across unit, widget, integration, and performance
- **Validation Report**: Created comprehensive validation report at docs/validation/story-3.11-validation-report.md
- **QA Fix Applied**: Added E2E test comparing preview to export output (DATA-001 coverage gap closed)

### File List
**Created Files**:
- lib/features/export/domain/services/csv_preview_service.dart
- lib/features/export/presentation/widgets/csv_preview_table.dart
- lib/features/export/presentation/providers/csv_preview_provider.dart
- test/unit/domain/services/csv_preview_service_test.dart
- test/widget/features/export/csv_preview_table_test.dart
- test/unit/features/export/csv_preview_provider_test.dart
- test/performance/csv_preview_performance_test.dart
- test/integration/csv_preview_export_consistency_test.dart (QA fix)
- docs/validation/story-3.11-validation-report.md

**Modified Files**:
- lib/features/export/presentation/pages/export_screen.dart (integrated preview)
- apps/mobile/pubspec.yaml (SDK version adjustment for compatibility)

## QA Results

### Requirements Tracing (2025-01-09)
- **Coverage**: 100% of acceptance criteria have test coverage
- **Test Distribution**: Unit (37%), Widget (41%), Performance (11%), Integration (11%)
- **Critical NFRs**: All fully tested (SEC-001, PERF-001, DATA-001)
- **Minor Gap**: No E2E test comparing preview to actual export (low risk)
- **Details**: docs/qa/assessments/3.11-trace-20250109.md

### NFR Assessment (2025-01-09)
- **Security**: PASS - Comprehensive CSV injection prevention
- **Performance**: PASS - Verified <100ms for 100 receipts
- **Reliability**: PASS - Proper error handling and graceful degradation
- **Maintainability**: PASS - 37 tests, clean architecture
- **Quality Score**: 100/100
- **Details**: docs/qa/assessments/3.11-nfr-20250109.md

### Test Coverage Summary
- ✅ 10 unit tests for service logic and security
- ✅ 15 widget tests for UI components
- ✅ 8 provider tests for state management
- ✅ 4 performance tests validating <100ms target
- ✅ All OWASP CSV injection patterns detected
- ✅ Export blocking on security issues verified

### Recommendations
1. Add E2E test comparing preview to export (low priority)
2. Consider request throttling for preview generation
3. Add telemetry for security block events