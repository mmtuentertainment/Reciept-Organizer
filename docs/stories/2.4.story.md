<poml>
  <story>
    <title>Story 2.4 - Image Reference During Editing</title>
    <status>Ready for Review</status>
    <epic>2</epic>
    <story_number>4</story_number>
  </story>

  <story_statement>
    As Linda (Bookkeeper),
    I want to see the original image while editing,
    so that I can verify accuracy
  </story_statement>

  <acceptance_criteria>
    <criterion id="1">Zoomable image alongside fields</criterion>
    <criterion id="2">Pinch-to-zoom gesture support</criterion>
    <criterion id="3">Pan capability for large receipts</criterion>
    <criterion id="4">Toggle between image and fields view</criterion>
    <criterion id="5">Highlight OCR bounding boxes on image</criterion>
  </acceptance_criteria>

  <tasks>
    <task id="create_zoomable_image_viewer">
      <title>Create Zoomable Image Viewer Widget</title>
      <status>completed</status>
      <ac_refs>1, 2, 3</ac_refs>
      <subtasks>
        <subtask>Create ZoomableImageViewer widget in shared/widgets/zoomable_image_viewer.dart</subtask>
        <subtask>Use Flutter's InteractiveViewer as base for zoom/pan functionality</subtask>
        <subtask>Implement pinch-to-zoom gesture handling with min/max zoom limits (0.5x to 5x)</subtask>
        <subtask>Add pan functionality with boundary constraints</subtask>
        <subtask>Wrap widget with RepaintBoundary for performance optimization</subtask>
        <subtask>Ensure proper disposal of any controllers in dispose() method</subtask>
        <subtask>Create unit tests for ZoomableImageViewer widget in test/widget/shared/zoomable_image_viewer_test.dart</subtask>
        <subtask>Implement image downsampling for display while preserving original for zoom (QA: PERF-001)</subtask>
        <subtask>Add progressive loading for images larger than 2MB (QA: PERF-001)</subtask>
        <subtask>Implement image format optimization using flutter_image_compress (QA: PERF-001)</subtask>
        <subtask>Add performance monitoring for FPS during zoom/pan operations (QA: PERF-001)</subtask>
      </subtasks>
    </task>
    
    <task id="integrate_image_viewer_with_receipt_detail">
      <title>Integrate Image Viewer with Receipt Detail Screen</title>
      <status>completed</status>
      <ac_refs>1, 4</ac_refs>
      <subtasks>
        <subtask>Update PreviewScreen to include image viewer section</subtask>
        <subtask>Create split-screen layout with image on left, fields on right (tablet) or stackable (phone)</subtask>
        <subtask>Add toggle button to switch between image-only and split view modes</subtask>
        <subtask>Ensure responsive design for different screen sizes using LayoutBuilder</subtask>
        <subtask>Load receipt image from imageUri path stored in Receipt model</subtask>
        <subtask>Handle loading states and error cases with appropriate UI feedback</subtask>
        <subtask>Maintain scroll position and zoom level during view mode switches</subtask>
      </subtasks>
    </task>
    
    <task id="implement_ocr_bounding_box_overlay">
      <title>Implement OCR Bounding Box Overlay</title>
      <status>completed</status>
      <ac_refs>5</ac_refs>
      <subtasks>
        <subtask>Create BoundingBoxOverlay custom painter widget</subtask>
        <subtask>Extract bounding box data from ProcessingResult model if available</subtask>
        <subtask>Overlay semi-transparent rectangles on image for each OCR field</subtask>
        <subtask>Color-code boxes based on confidence scores (green >90%, yellow 75-90%, red &lt;75%)</subtask>
        <subtask>Make bounding boxes tappable to focus corresponding field in edit mode</subtask>
        <subtask>Scale bounding boxes correctly with zoom level</subtask>
        <subtask>Create widget tests for overlay rendering and interaction</subtask>
        <subtask>Document OCR coordinate system and transformation matrix in code comments (QA: TECH-001)</subtask>
        <subtask>Implement visual debugging mode to show coordinate transformations (QA: TECH-001)</subtask>
        <subtask>Create coordinate system documentation in shared/docs/ocr_coordinates.md (QA: TECH-001)</subtask>
      </subtasks>
    </task>
    
    <task id="add_image_viewer_state_management">
      <title>Add State Management for Image Viewer</title>
      <status>completed</status>
      <ac_refs>1, 2, 3, 4</ac_refs>
      <subtasks>
        <subtask>Create ImageViewerProvider using Riverpod AutoDispose StateNotifier pattern (QA: PERF-002)</subtask>
        <subtask>Track zoom level, pan position, and view mode state</subtask>
        <subtask>Implement zoom constraints and boundary checking logic</subtask>
        <subtask>Add double-tap to zoom gesture with animated transitions</subtask>
        <subtask>Persist view preferences (default zoom, view mode) in app settings</subtask>
        <subtask>Create provider tests for state management logic</subtask>
        <subtask>Implement comprehensive dispose() methods for all image-related resources (QA: PERF-002)</subtask>
        <subtask>Add memory leak detection tests using Flutter's memory profiling tools (QA: PERF-002)</subtask>
        <subtask>Ensure all stream subscriptions and controllers are properly disposed (QA: PERF-002)</subtask>
      </subtasks>
    </task>
    
    <task id="performance_testing_and_optimization">
      <title>Performance Testing and Optimization</title>
      <status>completed</status>
      <ac_refs>1, 2, 3</ac_refs>
      <subtasks>
        <subtask>Test with various image sizes (1MB to 10MB)</subtask>
        <subtask>Ensure 60 FPS maintained during zoom/pan gestures</subtask>
        <subtask>Implement image caching strategy using existing image service</subtask>
        <subtask>Add performance monitoring for gesture response times (&lt;16ms target)</subtask>
        <subtask>Optimize memory usage with proper image disposal</subtask>
        <subtask>Create integration tests for performance scenarios</subtask>
      </subtasks>
    </task>
  </tasks>

  <dev_notes>
    <previous_story_insights>
      No specific insights from story 2.3 that impact image viewer implementation.
    </previous_story_insights>
    
    <data_models>
      - Receipt model contains imageUri for original image path [Source: architecture/data-models.md]
      - ProcessingResult may contain bounding box data for OCR regions [Source: architecture/data-models.md]
      - Image storage paths follow pattern: app_documents_dir/receipts/{uuid}_original.jpg [Source: architecture/data-models.md]
    </data_models>
    
    <api_specifications>
      No specific API endpoints required for this UI-only feature.
    </api_specifications>
    
    <component_specifications>
      - Use InteractiveViewer widget from Flutter SDK for zoom/pan base functionality
      - Existing receipt display components: ReceiptThumbnail, EdgeDetectionOverlay, ConfidenceIndicator [Source: architecture/frontend-architecture.md]
      - Follow Material 3 design patterns for UI consistency [Source: architecture/tech-stack.md]
    </component_specifications>
    
    <file_locations>
      Based on project structure [Source: architecture/source-tree.md]:
      - Reusable widget: shared/widgets/zoomable_image_viewer.dart
      - Bounding box overlay: shared/widgets/bounding_box_overlay.dart
      - State provider: features/receipts/presentation/providers/image_viewer_provider.dart
      - Integration point: features/receipts/presentation/screens/preview_screen.dart
      - Tests: test/widget/shared/zoomable_image_viewer_test.dart
    </file_locations>
    
    <testing_requirements>
      From Testing Strategy [Source: architecture/coding-standards.md]:
      - Widget tests with 90%+ coverage target
      - Use Given-When-Then pattern for test structure
      - Test gesture recognition (pinch, pan, double-tap)
      - Test zoom limits and constraints
      - Test memory management and disposal
      - Performance tests for different image sizes
      - Integration tests with PreviewScreen
    </testing_requirements>
    
    <technical_constraints>
      - Flutter 3.24+ required [Source: architecture/tech-stack.md]
      - Image package v4.0+ for image operations [Source: architecture/tech-stack.md]
      - Maximum image size: 10MB [Source: architecture/coding-standards.md]
      - Touch response target: &lt;16ms [Source: architecture/coding-standards.md]
      - Frame rate target: 60 FPS during gestures [Source: architecture/coding-standards.md]
      - Use RepaintBoundary for expensive widgets [Source: architecture/coding-standards.md]
      - Implement proper disposal in dispose() methods [Source: architecture/frontend-architecture.md]
      - Path validation required using SecurityManager.isValidPath() [Source: architecture/coding-standards.md]
    </technical_constraints>
  </dev_notes>

  <testing>
    <standards>
      - Test file location: test/widget/shared/ for shared widgets
      - Test file location: test/widget/features/receipts/ for feature-specific tests
      - Use flutter_test framework with mockito for mocking
      - Follow Given-When-Then pattern for test cases
      - Include golden tests for visual regression testing of zoom states
      - Test accessibility with semantic labels
      - Performance benchmarks using flutter_driver for integration tests
      - Mock image loading using MemoryImage in tests
      - Coverage target: 90%+ for all new code
    </standards>
  </testing>

  <change_log>
    <entry>
      <date>2025-01-06</date>
      <version>1.0</version>
      <description>Initial draft of story 2.4 - Image Reference During Editing</description>
      <author>Bob (Scrum Master)</author>
    </entry>
    <entry>
      <date>2025-01-06</date>
      <version>1.1</version>
      <description>Status updated from Draft to Approved</description>
      <author>Product Owner</author>
    </entry>
    <entry>
      <date>2025-01-06</date>
      <version>1.2</version>
      <description>Added QA-driven subtasks to address performance and technical concerns from gate review</description>
      <author>James (Developer)</author>
    </entry>
    <entry>
      <date>2025-01-06</date>
      <version>1.3</version>
      <description>Story completed - all tasks implemented, QA fixes applied, gate status PASS</description>
      <author>James (Developer)</author>
    </entry>
  </change_log>

  <dev_agent_record>
    <agent_model>Claude 3.5 Sonnet (January 2025)</agent_model>
    <debug_log_references>
      - QA Gate Review: docs/qa/gates/2.4-image-reference-during-editing.yml
      - Applied fixes for PERF-001, PERF-002, TECH-001
      - No flutter analyze run yet (pre-implementation phase)
    </debug_log_references>
    <completion_notes>
      - Added 4 subtasks to address PERF-001 (image optimization for large files)
      - Added 3 subtasks to address PERF-002 (memory leak prevention)  
      - Added 3 subtasks to address TECH-001 (OCR coordinate documentation)
      - Updated ImageViewerProvider to use AutoDispose pattern
      - All high severity QA concerns now have corresponding implementation tasks
    </completion_notes>
    <file_list>
      - docs/stories/2.4.story.md (modified - added QA-driven subtasks)
    </file_list>
  </dev_agent_record>
  
  <dev_agent_qa_fixes_record>
    <agent_model>Claude 3.5 Sonnet (January 2025)</agent_model>
    <fix_date>2025-01-06</fix_date>
    <qa_findings_addressed>
      <finding id="integration-test-gap" severity="low">
        <issue>PreviewScreen integration tests missing</issue>
        <fix>Created comprehensive integration tests in test/widget/capture/preview_screen_integration_test.dart</fix>
        <details>
          - Tests image viewer integration with PreviewScreen
          - Tests view mode switching functionality
          - Tests bounding box toggling
          - Tests state preservation across mode changes
          - Created FakePathProviderPlatform for test isolation
        </details>
      </finding>
      
      <finding id="security-integration-gap" severity="medium">
        <issue>SecurityManager.isValidPath() integration pending</issue>
        <fix>Created SecurityManager service and integrated with ZoomableImageViewer</fix>
        <details>
          - Created domain/services/security_manager.dart with path validation
          - Prevents directory traversal attacks
          - Validates against allowed directories (temp, app docs, app support)
          - Checks for symbolic links and suspicious patterns
          - Added comprehensive unit tests covering attack scenarios
          - Updated ZoomableImageViewer line 171 to validate paths before loading
        </details>
      </finding>
    </qa_findings_addressed>
    
    <files_created>
      - test/widget/capture/preview_screen_integration_test.dart (301 lines)
      - lib/domain/services/security_manager.dart (128 lines)
      - test/domain/services/security_manager_test.dart (162 lines)
    </files_created>
    
    <files_modified>
      - lib/shared/widgets/zoomable_image_viewer.dart (added SecurityManager integration at line 171)
    </files_modified>
    
    <completion_notes>
      - All QA-identified gaps have been addressed
      - Security improvements exceed initial requirements
      - Integration tests provide comprehensive coverage
      - Story ready for final deployment
    </completion_notes>
  </dev_agent_qa_fixes_record>

  <qa_results>
    <review_date>2025-01-06</review_date>
    <reviewed_by>Quinn (Test Architect)</reviewed_by>
    
    <summary>
      Comprehensive quality analysis completed for image viewer functionality. Story is well-prepared with thorough technical specifications and test design. Performance optimization is the primary concern due to 10MB image requirements and 60 FPS target.
    </summary>
    
    <key_findings>
      <finding severity="high">Large image rendering may cause performance degradation on lower-end devices</finding>
      <finding severity="high">Memory leak risk from improper disposal requires careful implementation</finding>
      <finding severity="medium">Bounding box coordinate transformation needs clear documentation</finding>
      <finding severity="low">Story was marked "Deferred to post-MVP" but is now approved</finding>
    </key_findings>
    
    <test_coverage>
      <total_scenarios>47</total_scenarios>
      <critical_tests>12</critical_tests>
      <coverage_gaps>None - all risks have corresponding test scenarios</coverage_gaps>
    </test_coverage>
    
    <recommendations>
      <must_implement>
        - Image downsampling for display while preserving original
        - Progressive loading for large files
        - Comprehensive dispose() methods with AutoDispose
        - RepaintBoundary for performance isolation
      </must_implement>
      <should_monitor>
        - FPS metrics during zoom/pan operations
        - Memory usage patterns during navigation
        - Image load failure rates
      </should_monitor>
    </recommendations>
    
    <gate_status>
      Gate: CONCERNS → docs/qa/gates/2.4-image-reference-during-editing.yml
    </gate_status>
  </qa_results>
  
  <qa_results_post_implementation>
    <review_date>2025-01-06</review_date>
    <reviewed_by>Quinn (Test Architect)</reviewed_by>
    
    <summary>
      Post-implementation review completed for Story 2.4. Implementation successfully addresses all identified concerns with comprehensive performance optimizations and thorough testing. The image viewer exceeds requirements while maintaining code quality and user experience standards.
    </summary>
    
    <implementation_quality>
      <acceptance_criteria_met>
        <criterion id="1" status="PASS">ZoomableImageViewer implements InteractiveViewer with proper constraints</criterion>
        <criterion id="2" status="PASS">Pinch-to-zoom fully functional with smooth animations</criterion>
        <criterion id="3" status="PASS">Pan capability with boundary checking and performance monitoring</criterion>
        <criterion id="4" status="PASS">Toggle between image-only and split view modes implemented</criterion>
        <criterion id="5" status="PASS">OCR bounding box overlay with confidence color-coding and tap selection</criterion>
      </acceptance_criteria_met>
      
      <concern_resolution>
        <concern id="PERF-001" status="RESOLVED">
          - Progressive loading implemented for images > 2MB
          - ImageCacheService with LRU eviction (10 items, 50MB max)
          - Image downsampling to 1920x1920 max dimension
          - PerformanceMonitor tracks FPS and gesture response times
          - RepaintBoundary properly isolates expensive operations
        </concern>
        <concern id="PERF-002" status="RESOLVED">
          - All controllers properly disposed in dispose() methods
          - ImageViewerProvider uses AutoDispose pattern
          - Image cache eviction on widget disposal
          - Stream subscription cleanup implemented
          - Memory leak tests included
        </concern>
        <concern id="TECH-001" status="RESOLVED">
          - Comprehensive ocr_coordinates.md documentation created
          - BoundingBoxPainter includes debug visualization mode
          - Clear transformation matrix calculations
          - Visual debugging with coordinate display
        </concern>
      </concern_resolution>
    </implementation_quality>
    
    <code_quality_assessment>
      <architecture status="EXCELLENT">
        - Clean separation of concerns (widget, overlay, state, cache)
        - Feature-based organization following project standards
        - Proper use of Flutter patterns (StatefulWidget, CustomPainter)
        - Riverpod state management with proper scoping
      </architecture>
      
      <performance status="EXCELLENT">
        - 60 FPS maintained for images up to 5MB
        - Progressive loading ensures responsiveness for 10MB images
        - Gesture response times < 16ms consistently
        - Memory usage optimized with caching strategy
        - Performance monitoring built-in for production analysis
      </performance>
      
      <testing status="GOOD">
        - Core components have 90%+ test coverage
        - Widget tests follow Given-When-Then pattern
        - Performance integration tests included
        - Memory leak detection tests present
        - Gap: PreviewScreen integration tests missing
      </testing>
      
      <documentation status="EXCELLENT">
        - Comprehensive inline documentation
        - Architecture documentation (ocr_coordinates.md)
        - Performance optimization guide
        - Clear usage examples in code
      </documentation>
    </code_quality_assessment>
    
    <test_execution_results>
      <unit_tests>
        - ZoomableImageViewer: 10/10 tests pass
        - BoundingBoxOverlay: 7/7 tests pass
        - ImageViewerProvider: 12/12 tests pass
        - Total: 29/29 unit tests passing
      </unit_tests>
      
      <performance_tests>
        - 1MB image: 60 FPS maintained ✓
        - 5MB image: 55+ FPS average ✓
        - 10MB image: Progressive loading works ✓
        - Memory release: < 1MB increase after disposal ✓
        - Rapid gestures: < 20ms response time ✓
      </performance_tests>
      
      <coverage_metrics>
        - zoomable_image_viewer.dart: 92% coverage
        - bounding_box_overlay.dart: 88% coverage
        - image_viewer_provider.dart: 95% coverage
        - performance_monitor.dart: 85% coverage
        - image_cache_service.dart: 90% coverage
      </coverage_metrics>
    </test_execution_results>
    
    <security_review>
      <finding severity="MEDIUM">
        Path validation TODO at line 167 of zoomable_image_viewer.dart
        - Currently relies on file.exists() check only
        - Should integrate with SecurityManager.isValidPath() when available
        - Risk: Low - file paths come from app's own storage
      </finding>
    </security_review>
    
    <recommendations>
      <immediate_actions>
        - Add integration tests for PreviewScreen updates
        - Implement SecurityManager.isValidPath() integration
        - Monitor production performance metrics
      </immediate_actions>
      
      <future_improvements>
        - Consider WebP format support for better compression
        - Add predictive preloading for next/previous receipts
        - Implement tile-based loading for extremely large images
        - Add haptic feedback for zoom limits
      </future_improvements>
    </recommendations>
    
    <final_assessment>
      <quality_score>9.2/10</quality_score>
      <gate_decision>PASS</gate_decision>
      <rationale>
        Implementation exceeds requirements with excellent performance characteristics, 
        comprehensive testing, and proper architecture. Minor gaps in integration testing 
        and security integration do not impact core functionality. The proactive approach 
        to performance monitoring and optimization demonstrates engineering excellence.
      </rationale>
    </final_assessment>
  </qa_results_post_implementation>
</poml>