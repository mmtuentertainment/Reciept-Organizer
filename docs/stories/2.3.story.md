```poml
story:
  title: "Story 2.3 - Add Notes to Receipts"
  status: Ready for Done
  epic: 2
  story_number: 3

story_statement: |
  As Sarah (Restaurant Owner),
  I want to add notes to receipts,
  so that I can remember context

acceptance_criteria:
  - id: 1
    description: "Optional note field, searchable"

tasks:
  - id: add_notes_field_to_ui
    title: "Add Notes Field to Receipt UI"
    status: completed
    ac_refs: [1]
    subtasks:
      - "Add notes text field to PreviewScreen below extracted fields"
      - "Create NotesFieldEditor widget with Material TextFormField"
      - "Implement character limit (500 chars) with counter display"
      - "Add hint text 'Add notes about this receipt...'"
      - "Ensure keyboard doesn't obscure input field"
      - "Create unit tests for NotesFieldEditor widget"
      
  - id: integrate_notes_with_storage
    title: "Integrate Notes Field with Storage Layer"
    status: completed
    ac_refs: [1]
    subtasks:
      - "Update Receipt model to ensure notes field is properly mapped"
      - "Modify ReceiptRepository save/update methods to persist notes"
      - "Ensure notes are saved on field blur (auto-save pattern)"
      - "Add notes to export data in CSV generation"
      - "Verify notes persistence across app restarts"
      - "Create integration tests for notes persistence"
      
  - id: implement_notes_search
    title: "Implement Notes Search Functionality"
    status: completed
    ac_refs: [1]
    subtasks:
      - "Update queryReceipts method to include notes in search term matching"
      - "Add SQL LIKE query for notes field in receipts table"
      - "Ensure search is case-insensitive"
      - "Highlight matching text in search results (future enhancement)"
      - "Test search with various note content including special characters"
      - "Add performance test for search with 1000+ receipts"
      
  - id: update_receipt_detail_screen
    title: "Display Notes in Receipt Detail View"
    status: completed
    ac_refs: [1]
    subtasks:
      - "Add notes display section to ReceiptDetailScreen"
      - "Show notes below core receipt fields"
      - "Implement inline editing for notes in detail view"
      - "Add empty state text when no notes present"
      - "Ensure notes are displayed in receipt card preview (truncated)"
      - "Test UI on various screen sizes"

dev_context:
  previous_story_insights: |
    From Story 2.2 (Merchant Name Normalization):
    - Established pattern for adding new fields to receipt UI (merchant normalization indicator)
    - Created field update patterns in PreviewScreen that notes field must follow
    - Auto-save patterns implemented that notes should integrate with
    - Settings infrastructure in place if notes feature needs configuration
    
    From Story 2.1 (Edit Low-Confidence Fields):
    - FieldEditor components established for inline editing
    - Optimistic update patterns with Riverpod state management
    - Keyboard handling patterns for text input fields
    
  architecture_context: |
    [Source: architecture/data-models.md#receipt_entity]
    Receipt Model Notes Field:
    - notes: "string? - User notes" (already exists in model line 246)
    - Field is optional (nullable) 
    - Stored directly in receipts table for query performance
    
    [Source: architecture/database-schema.md#receipts_table]
    Database Schema:
    - notes TEXT column already exists in receipts table (line 74)
    - No migration needed - field already in schema
    - Indexed for search performance as part of receipt queries
    
    [Source: architecture/frontend-architecture.md#state_management]
    State Management Pattern:
    - Use Riverpod AsyncNotifier for receipt updates
    - ref.invalidateSelf() to trigger UI rebuilds
    - Optimistic updates for immediate UI feedback
    
    [Source: architecture/core-workflows.md#receipt_capture_workflow]
    Integration Point:
    - Notes can be added during preview/edit phase
    - Part of saveReceipt() flow in State Manager
    - Persisted with other receipt data
    
  data_models: |
    [Source: architecture/data-models.md#receipt_model]
    Receipt Model (existing):
    ```dart
    class Receipt {
      final String id;
      final String imageUri;
      final String thumbnailUri;
      final DateTime capturedAt;
      final ReceiptStatus status;
      final ProcessingResult ocrResults;
      final ReceiptMetadata metadata;
      final DateTime lastModified;
      final String? notes;  // Already exists
      final bool isDeleted;
      final int version;
    }
    ```
    
    No model changes required - notes field already present
    
  file_locations: |
    [Source: architecture/source-tree.md#mobile_app_structure]
    New Widget Implementation:
    - lib/features/capture/presentation/widgets/notes_field_editor.dart
    - lib/features/receipts/presentation/widgets/receipt_notes_display.dart
    
    Modified Existing Files:
    - lib/features/capture/presentation/screens/preview_screen.dart (add notes field)
    - lib/features/receipts/presentation/screens/receipt_detail_screen.dart (show notes)
    - lib/features/receipts/presentation/widgets/receipt_card.dart (truncated notes)
    - lib/core/repositories/receipt_repository.dart (ensure notes persisted)
    - lib/features/receipts/providers/receipt_list_provider.dart (search functionality)
    - lib/core/services/export_service.dart (include notes in CSV)
    
    Test Files:
    - test/widget/capture/notes_field_editor_test.dart
    - test/integration/notes_persistence_flow_test.dart
    - test/unit/repositories/receipt_repository_notes_test.dart
    - test/unit/providers/receipt_search_notes_test.dart
    
  ui_components: |
    [Source: architecture/frontend-architecture.md#custom_components]
    Notes Field Design:
    - Material TextFormField with outline border
    - Character counter in trailing position
    - Multi-line with maxLines: 3 (expandable)
    - Auto-save on blur following established patterns
    - Consistent with existing form field styling
    
    Receipt Card Preview:
    - Show first 50 characters of notes with ellipsis
    - Secondary text style below merchant/date
    - Only show if notes present (no empty state in card)
    
  performance_requirements: |
    [Source: architecture/coding-standards.md#performance_standards]
    Search Performance:
    - Notes search must complete in <100ms for 1000 receipts
    - Use SQL LIKE with index optimization
    - Consider full-text search in future if performance degrades
    
    UI Performance:
    - Auto-save debounced to 500ms after last keystroke
    - No UI blocking during save operation
    - Optimistic updates for immediate feedback
    
  testing_standards: |
    [Source: architecture/testing-strategy.md#test_organization]
    Test Requirements:
    - Widget tests for NotesFieldEditor component
    - Integration test for full notes flow (add, save, search)
    - Unit tests for repository notes persistence
    - Search functionality tests with edge cases
    - Performance test with 1000+ receipts
    
    Test Coverage:
    - Target 90%+ code coverage
    - Use Given-When-Then pattern
    - Mock external dependencies with mockito
    
  project_structure_notes: |
    Perfect alignment with existing architecture. Notes field already exists in 
    data model and database schema, so this is purely a UI/UX implementation story.
    No architectural changes or migrations required. Search functionality leverages
    existing query infrastructure with minimal modifications. Feature follows all
    established patterns for field editing and persistence.

change_log:
  - date: 2025-09-06
    version: 1.0
    description: "Initial story creation with comprehensive architecture context"
    author: "Bob (Scrum Master)"
  
  - date: 2025-01-06
    version: 1.1
    description: "Applied QA fixes: Added input sanitization, performance test, and E2E test"
    author: "James (Developer)"

dev_agent_record:
  agent_model: claude-opus-4-20250514
  debug_log_references:
    - "Performance test created at test/performance/receipt_search_performance_test.dart"
    - "Input sanitization added to NotesFieldEditor with comprehensive test coverage"
    - "E2E test created at test/e2e/notes_workflow_test.dart"
    - "All QA-identified gaps addressed per priority order"
  completion_notes: |
    Successfully implemented all tasks for Story 2.3:
    
    1. Created NotesFieldEditor widget with 500 character limit and counter
    2. Updated Receipt model to include notes field with proper serialization
    3. Integrated notes in CSV export for all formats (QuickBooks, Xero, Generic)
    4. Created ReceiptListProvider with comprehensive notes search functionality
    5. Updated PreviewScreen to include notes field below OCR fields
    6. Enhanced ReceiptDetailScreen with notes display and editing
    7. Added notes preview to ReceiptCard for list view
    8. Created ReceiptNotesDisplay widget for read-only presentation
    
    All tests created and implementation follows established patterns.
    Notes field already existed in database schema - no migration needed.
    
    QA Fixes Applied (2025-01-06):
    1. Added input sanitization layer to NotesFieldEditor
       - Removes control characters and potentially harmful patterns
       - Preserves legitimate content including special characters
       - Added comprehensive tests for sanitization logic
    2. Created performance test for search functionality
       - Tests search through 1500 receipts completes in <100ms
       - Includes rapid search and complex pattern tests
       - Verifies linear scaling with dataset size
    3. Created E2E test for complete notes workflow
       - Covers capture, edit, search, and export scenarios
       - Tests edge cases including max length and special characters
       - Includes sanitization verification
  file_list:
    - lib/features/capture/widgets/notes_field_editor.dart
    - lib/features/capture/screens/preview_screen.dart
    - lib/data/models/receipt.dart
    - lib/domain/services/csv_export_service.dart
    - lib/features/receipts/providers/receipt_list_provider.dart
    - lib/features/receipts/presentation/screens/receipt_detail_screen.dart
    - lib/features/receipts/presentation/widgets/receipt_card.dart
    - lib/features/receipts/presentation/widgets/receipt_notes_display.dart
    - test/widget/capture/notes_field_editor_test.dart
    - test/integration/notes_persistence_flow_test.dart
    - test/unit/providers/receipt_search_notes_test.dart
    - test/performance/receipt_search_performance_test.dart
    - test/e2e/notes_workflow_test.dart

qa_results:
  - date: 2025-01-06
    assessment_type: "requirements_trace"
    result: "PASS"
    coverage: "95%"
    findings:
      - "All acceptance criteria fully covered with tests"
      - "19 unit tests + 8 integration tests = 27 total"
      - "Excellent Given-When-Then patterns"
      - "Minor gap: E2E tests not implemented (acceptable)"
      - "Performance test mentioned but not implemented"
    
  - date: 2025-01-06
    assessment_type: "nfr_validation"
    result: "PASS WITH MINOR CONCERNS"
    findings:
      security:
        - rating: "GOOD"
        - "Proper input validation with 500 char limit"
        - "Minor: Consider input sanitization for defense in depth"
      
      performance:
        - rating: "GOOD WITH CONCERNS"
        - "Auto-save debounce: 500ms ✓"
        - "Concern: Performance test not implemented"
        - "SQL LIKE queries may not scale well"
      
      reliability:
        - rating: "EXCELLENT"
        - "Robust error handling and null safety"
        - "Auto-save prevents data loss"
      
      maintainability:
        - rating: "EXCELLENT"
        - "Clean architecture, good patterns"
        - "High test coverage"
        - "Reusable components"
      
      accessibility:
        - rating: "NEEDS ATTENTION"
        - "Missing screen reader labels"
        - "Character counter not announced"
        - "Recommend adding accessibility support"
    
    recommendations:
      - "Implement performance test before scaling"
      - "Add screen reader support (1-2 hour effort)"
      - "Document best practices for notes content"
  
  - date: 2025-01-06
    assessment_type: "comprehensive_review"
    reviewed_by: "Quinn (Test Architect)"
    
    code_quality_assessment: |
      Overall implementation quality is EXCELLENT. The code follows established patterns,
      maintains clean separation of concerns, and demonstrates proper Flutter best practices.
      The feature integrates seamlessly with existing architecture without requiring any
      database migrations (notes field already existed in schema).
    
    refactoring_performed:
      - file: "lib/features/capture/widgets/notes_field_editor.dart"
        change: "Added semanticsLabel to InputDecoration"
        why: "Screen readers need context about the field purpose and constraints"
        how: "Improves accessibility by announcing field purpose and character limit"
      
      - file: "lib/features/capture/widgets/notes_field_editor.dart"  
        change: "Wrapped character counter in Semantics widget with liveRegion"
        why: "Character count changes weren't announced to screen readers"
        how: "Live region ensures count updates are announced for better accessibility"
    
    compliance_check:
      - "Coding Standards: ✓ Follows Flutter conventions and project patterns"
      - "Project Structure: ✓ Feature-based organization maintained"
      - "Testing Strategy: ✓ Unit and integration tests comprehensive"
      - "All ACs Met: ✓ Optional searchable notes field fully implemented"
    
    improvements_checklist:
      - "[x] Added accessibility support for screen readers"
      - "[x] Improved character counter announcement"
      - "[ ] Implement performance test with 1000+ receipts"
      - "[ ] Consider adding input sanitization layer"
      - "[ ] Add E2E test for complete notes workflow"
      - "[ ] Document notes best practices for users"
    
    security_review: |
      No critical security issues found. Input validation properly enforced via
      500 character limit. Flutter's rendering engine handles potential XSS safely.
      Plain text storage acceptable for offline-first single-user app.
    
    performance_considerations: |
      Auto-save debounce (500ms) prevents excessive writes. SQL LIKE queries may
      degrade with large datasets - monitor and implement full-text search if needed.
      No UI blocking observed during saves due to proper async handling.
    
    files_modified_during_review:
      - "lib/features/capture/widgets/notes_field_editor.dart (accessibility improvements)"
    
    gate_status:
      gate: "PASS"
      gate_file: "docs/qa/gates/2.3-add-notes-to-receipts.yml"
      risk_profile: "LOW (3.5/10)"
      quality_score: 100
    
    recommended_status: "✓ Ready for Done"
    
    detailed_findings:
      risk_assessment:
        - "8 total risks: 0 critical, 0 high, 2 medium, 6 low"
        - "Main concerns: SQL LIKE scalability, missing performance tests"
        - "All risks have clear mitigation strategies"
      
      test_coverage:
        - "27 tests total (19 unit + 8 integration)"
        - "Core functionality: 100% covered"
        - "Edge cases: Well handled (null vs empty, special chars, limits)"
        - "Missing: E2E tests, performance benchmarks"
      
      architectural_impact:
        - "Zero breaking changes"
        - "Leverages existing Receipt model (notes field pre-existed)"
        - "Follows established FieldEditor patterns"
        - "Minimal integration points reduce risk"
```