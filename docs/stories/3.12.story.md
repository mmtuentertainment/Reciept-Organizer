# Story 3.12: Export Validation

## Status
Approved

## Story
**As a** Sarah (Restaurant Owner),
**I want** export validation before generating the file,
**so that** I know it will import successfully into QuickBooks

## Acceptance Criteria
1. Pre-flight validation check with specific warnings
2. Field format validation (dates, amounts)
3. Required field verification
4. Success confirmation with file location
5. Error handling for edge cases
6. Validation report before export

## Tasks / Subtasks
- [ ] Task 1: Create Validation Rule Engine (AC: 1, 2, 3, 6)
  - [ ] Create ExportValidator service in features/export/domain/export_validator.dart
  - [ ] Define ValidationRule interface with validate() method and severity levels
  - [ ] Implement format-specific validator classes (QuickBooksValidator, XeroValidator, GenericValidator)
  - [ ] Create ValidationResult model with fields: isValid, warnings, errors, suggestions
  - [ ] Implement rule sets for date validation (format, reasonable range)
  - [ ] Implement rule sets for amount validation (positive, decimal places, tax <= total)
  - [ ] Implement rule sets for merchant validation (non-empty, length, special chars)
  - [ ] Create unit tests in test/unit/domain/services/export_validator_test.dart

- [ ] Task 2: Implement Pre-Flight Validation UI (AC: 1, 6)
  - [ ] Create ValidationReportDialog widget in features/export/presentation/widgets/validation_report_dialog.dart
  - [ ] Design dialog layout with sections for errors, warnings, and suggestions
  - [ ] Implement severity-based styling (red for errors, amber for warnings, blue for info)
  - [ ] Add "Fix Issues" and "Export Anyway" buttons (disable export for critical errors)
  - [ ] Include detailed validation messages with field references
  - [ ] Add scrollable content for long validation reports
  - [ ] Apply Material 3 theming from shared/theme/app_theme.dart
  - [ ] Create widget tests in test/widget/features/export/validation_report_dialog_test.dart

- [ ] Task 3: Integrate Validation with Export Flow (AC: 1, 4, 5)
  - [ ] Modify ExportScreen to run validation before CSV generation
  - [ ] Create exportValidationProvider using Riverpod AsyncNotifierProvider
  - [ ] Implement loading state during validation check
  - [ ] Block export when critical errors exist
  - [ ] Show validation dialog when issues are found
  - [ ] Allow "Export Anyway" for warnings only (not errors)
  - [ ] Pass validation results to CSVExportService for metadata inclusion
  - [ ] Update exportProvider to handle validation state
  - [ ] Create integration tests in test/integration/export_validation_flow_test.dart

- [ ] Task 4: Field Format Validation Implementation (AC: 2)
  - [ ] Create DateFormatValidator with format detection and conversion
  - [ ] Implement AmountFormatValidator for numeric validation
  - [ ] Add MerchantNameValidator for text field validation
  - [ ] Create TaxAmountValidator ensuring tax <= total
  - [ ] Implement format auto-correction where safe (e.g., date conversion)
  - [ ] Add format-specific validation for QuickBooks (MM/DD/YYYY dates, no currency symbols)
  - [ ] Add format-specific validation for Xero (DD/MM/YYYY dates, required fields marked)
  - [ ] Create comprehensive unit tests for each validator

- [ ] Task 5: Success Confirmation and File Location (AC: 4)
  - [ ] Create ExportSuccessDialog with file location display
  - [ ] Implement share functionality using ShareService
  - [ ] Show export summary (row count, date range, format used)
  - [ ] Add "Open File" button for quick access
  - [ ] Include validation summary if warnings were bypassed
  - [ ] Implement copy-to-clipboard for file path
  - [ ] Create widget tests for success dialog

- [ ] Task 6: Edge Case Handling (AC: 5)
  - [ ] Handle empty receipt list gracefully
  - [ ] Validate file system permissions before export
  - [ ] Handle storage full scenarios with clear messaging
  - [ ] Implement timeout for large export validation (>500 receipts)
  - [ ] Add retry mechanism for transient failures
  - [ ] Handle corrupted receipt data with skip option
  - [ ] Create error recovery suggestions for common issues
  - [ ] Add comprehensive error logging for debugging
  - [ ] Create edge case tests in test/integration/export_edge_cases_test.dart

## Dev Notes

### Previous Story Insights
From Story 3.11 completion:
- CSV injection prevention already implemented in CSVExportService (critical severity warnings)
- Preview generation uses same CSVExportService for consistency
- Performance monitoring framework in place
- Security validation patterns established in csv_preview_service.dart:168-196
- Export blocking mechanism exists in export_screen.dart:283-286, 439-459

### Data Models
Receipt model fields for validation [Source: docs/sharded-architecture/data-models.md#4.1]:
- id: String (UUID)
- ocrResults: ProcessingResult with confidence scores
- ProcessingResult contains:
  - merchantName: String with confidence
  - totalAmount: double with confidence
  - date: DateTime with confidence
  - taxAmount: double with confidence

ExportBatch model for tracking [Source: docs/sharded-architecture/data-models.md]:
- Will need to store validation results with export batch
- Track which validation rules were applied
- Record any warnings that were bypassed

### API Specifications
No external API calls - all validation is local [Source: docs/sharded-architecture/tech-stack.md#backend_layer]

### Component Specifications
Export feature module structure [Source: docs/sharded-architecture/source-tree.md]:
- features/export/domain/: Domain logic and validation rules (ExportValidator goes here, alongside validation_rules.dart)
- features/export/presentation/widgets/: Reusable widgets (ValidationReportDialog goes here)
- features/export/presentation/providers/: Riverpod providers (exportValidationProvider goes here)

State management requirements [Source: docs/sharded-architecture/tech-stack.md]:
- Use Riverpod AsyncNotifierProvider for async validation
- Implement loading states with AsyncValue wrapper
- Never mutate state directly - use copyWith patterns

### File Locations
Based on project structure [Source: docs/sharded-architecture/source-tree.md]:
- New validator service: lib/features/export/domain/export_validator.dart
- Validation dialog: lib/features/export/presentation/widgets/validation_report_dialog.dart
- Success dialog: lib/features/export/presentation/widgets/export_success_dialog.dart
- Validation provider: lib/features/export/presentation/providers/export_validation_provider.dart
- Unit tests: test/unit/domain/services/export_validator_test.dart
- Widget tests: test/widget/features/export/validation_report_dialog_test.dart
- Integration tests: test/integration/export_validation_flow_test.dart

### Testing Requirements
Testing standards [Source: docs/sharded-architecture/coding-standards.md]:
- All service methods must have try-catch and throw typed exceptions
- Widget tests for all UI components
- Integration tests for complete workflows
- Use mockito for mocking dependencies
- Follow AAA pattern (Arrange, Act, Assert)
- Test both happy path and error cases

### Technical Constraints
Critical coding rules [Source: docs/sharded-architecture/coding-standards.md#CRITICAL_RULES]:
- All service methods must use try-catch and throw typed exceptions
- Never mutate state directly - use Riverpod notifiers with copyWith
- Dispose all controllers and listeners in widget dispose() methods
- Always validate file paths with SecurityManager before operations

Naming conventions [Source: docs/sharded-architecture/coding-standards.md#NAMING_MATRIX]:
- Services: PascalCase with 'Service' suffix (ExportValidator.dart)
- Widgets: PascalCase (ValidationReportDialog.dart)
- Providers: camelCase with 'Provider' suffix (exportValidationProvider)

Material 3 theming [Source: docs/sharded-architecture/tech-stack.md#ui_system]:
- Use Material 3 design system throughout
- Apply theme from shared/theme/app_theme.dart
- Maintain consistency with existing export UI

### Data Privacy Considerations
Export data privacy requirements:
- CSV files contain business financial data - ensure secure file handling
- Do not include any personally identifiable information (PII) beyond business requirements
- File paths should be validated to prevent directory traversal attacks
- Exported files should be saved to user-accessible locations only
- Consider adding a privacy notice in the export success dialog about data sensitivity
- Log export events but never log the actual receipt data values

### Validation Rules from Epic
Date validation requirements:
- Valid date format for target system (MM/DD/YYYY for QuickBooks, DD/MM/YYYY for Xero)
- Reasonable date range (not future, not too old - suggest last 2 years)

Amount validation requirements:
- Positive numbers only
- Two decimal places exactly
- No currency symbols
- Tax amount must be less than or equal to total amount

Merchant validation requirements:
- Non-empty merchant names
- No special characters that break CSV (properly escape if present)
- Reasonable length (<100 characters)

QuickBooks specific requirements:
- File encoding: UTF-8 without BOM (already handled by CSVExportService)
- Line endings: CRLF (Windows)
- Field delimiter: Comma
- Text qualifier: Double quotes when needed
- Header row: Required

Xero specific requirements:
- Required fields: Date, ContactName, Total (mark with * in preview)
- Date format: DD/MM/YYYY strictly enforced
- Decimal separator: Period
- No trailing commas
- UTF-8 encoding required

### Performance Requirements
- Validation must complete in <500ms for 100 receipts
- Use streaming validation for large datasets (>500 receipts)
- Cache validation results during session to avoid re-validation

## Testing

### Test File Locations
- Unit tests: test/unit/domain/services/export_validator_test.dart
- Widget tests: test/widget/features/export/
- Integration tests: test/integration/export_validation_flow_test.dart
- Edge case tests: test/integration/export_edge_cases_test.dart

### Testing Standards
- Use Flutter test framework with mockito for mocking
- Test all validation rules with valid and invalid data
- Test format-specific validators separately
- Include performance tests for large datasets
- Test UI interactions (dialog buttons, scrolling)
- Verify export blocking on critical errors
- Test "Export Anyway" flow for warnings

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-10 | 1.0 | Initial story creation from Epic 3 | Bob (Scrum Master) |
| 2025-01-10 | 1.1 | Risk assessment and test design completed | Quinn (Test Architect) |
| 2025-01-10 | 1.2 | File structure clarified, privacy considerations added, story approved | Quinn (Test Architect) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Risk Assessment (2025-01-10)
- **Risk Score**: 33/100 (High Risk - Significant mitigation required)
- **Critical Risks**: 2 (Format incompatibility, CSV injection)
- **High Risks**: 4 (Performance, state management, false positives, data loss)
- **Must Fix**: DATA-001, SEC-001, TECH-001 before production
- **Details**: docs/qa/assessments/3.12-risk-20250110.md

### Test Design (2025-01-10)
- **Total Scenarios**: 42 (24 unit, 12 integration, 6 E2E)
- **Coverage**: 100% of acceptance criteria
- **P0 Tests**: 18 critical tests must pass
- **Security Tests**: Comprehensive CSV injection and path traversal coverage
- **Details**: docs/qa/assessments/3.12-test-design-20250110.md

### Critical QA Recommendations

#### Before Development
1. **Set up QuickBooks/Xero test environments** - Critical for format validation
2. **Create security test payload library** - OWASP CSV injection patterns
3. **Design streaming validation architecture** - Required for 500+ receipts
4. **Clarify file structure** - Resolve domain/services vs domain/ discrepancy

#### During Development
1. **Implement validation engine with clear separation** - Prevent state issues
2. **Add comprehensive error handling** - Try-catch with recovery
3. **Build security validation first** - Multiple layers of protection
4. **Create performance benchmarks early** - Track <500ms target

#### Testing Focus
1. **P0: Security testing** - All CSV injection patterns must be blocked
2. **P0: Format compliance** - Real QB/Xero import verification required
3. **P0: Large dataset handling** - 1000+ receipt performance validation
4. **P1: Error recovery** - User can fix and retry validation

### Quality Gate Decision
- **Status**: CONCERNS
- **Reason**: High risk profile requires careful implementation and testing
- **Conditions for PASS**: 
  - All P0 tests passing
  - Critical risks mitigated
  - Performance targets met
  - Real accounting software imports verified

### Gate Status
Gate: CONCERNS → docs/qa/gates/3.12-export-validation.yml

### Review Date: 2025-01-10 (Revised)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Implementation: INCOMPLETE (4/10)**

**CRITICAL FAILURE:** The implementation uses empty mock data instead of real receipts, despite the user having QuickBooks and Xero developer accounts ready for testing. This fundamental disconnect makes the entire validation system untested and unverifiable.

**The Fatal Flaw:**
```dart
// Line 439 in ExportScreen - THIS IS THE PROBLEM
// Get receipts for validation (TODO: implement actual receipt fetching)
final List<Receipt> receipts = [];  // ALWAYS EMPTY - NO VALIDATION HAPPENS!
```

**What This Means:**
- 🚫 **Zero actual validation occurs** - Validators process empty arrays
- 🚫 **QuickBooks format validation untested** - User's developer account unused
- 🚫 **Xero format validation untested** - User's developer account unused
- 🚫 **All validation logic is theoretical** - Never runs on real receipt data
- 🚫 **Cannot verify CSV imports work** - No real data to export and test

**Framework Strengths (But Untested):**
- Well-architected validation framework
- Robust CSV injection prevention patterns
- Format-specific validators for QB/Xero
- Clean separation of concerns
- User-friendly dialogs

**Critical Failures:**
1. **NO RECEIPT DATA CONNECTION** - Line 439 returns empty array
2. **NO REAL QUICKBOOKS TESTING** - Developer account available but unused
3. **NO REAL XERO TESTING** - Developer account available but unused
4. **VALIDATION NEVER RUNS** - Empty data means all validators are bypassed
5. **2 failing unit tests** - Even mock tests aren't fully passing

### Refactoring Performed

None performed during this review - code quality is already good. Recommended refactoring is listed below for developer to address.

### Compliance Check

- Coding Standards: ✓ Mostly compliant (minor linting issues)
- Project Structure: ✓ Follows features/domain/presentation pattern correctly
- Testing Strategy: ✓ Good test coverage but 2 tests failing
- All ACs Met: ✓ All 6 acceptance criteria implemented

### Required Actions (MUST Complete Before Story Closure)

#### 🔴 BLOCKING ISSUES - Story Cannot Pass Without These:

1. **IMPLEMENT RECEIPT FETCHING** (Line 439 in ExportScreen)
   ```dart
   // REPLACE THIS:
   final List<Receipt> receipts = [];
   
   // WITH THIS:
   final receipts = await ref.read(receiptRepositoryProvider)
       .getReceiptsInDateRange(startDate, endDate);
   ```

2. **TEST WITH QUICKBOOKS DEVELOPER ACCOUNT**
   - Export real receipts to CSV
   - Import CSV into QuickBooks sandbox
   - Verify all fields map correctly
   - Document any import errors

3. **TEST WITH XERO DEVELOPER ACCOUNT**
   - Export real receipts to CSV
   - Import CSV into Xero sandbox
   - Verify all fields map correctly
   - Document any import errors

4. **CONNECT VALIDATION TO REAL DATA**
   - Ensure validators receive actual Receipt objects
   - Test with minimum 10 real receipts
   - Verify validation messages are accurate

#### ⚠️ High Priority (Complete in same sprint):
- [ ] Fix 2 failing tests in export_validator_test.dart
- [ ] Add integration test with real receipt data
- [ ] Benchmark performance with 100+ receipts

#### 📝 Technical Debt (Can defer to next sprint):
- [ ] Remove unused imports and fields
- [ ] Replace deprecated Material APIs
- [ ] Add comprehensive error logging

### Security Review

**EXCELLENT Security Implementation**

Critical security features properly implemented:
- CSV Injection Prevention: Comprehensive OWASP pattern detection (=, +, -, @, tab, newline)
- Formula Pattern Detection: Blocks cmd|exec|system|eval|powershell|script
- DDE Attack Prevention: Detects =DDE|cmd.exe patterns
- Hyperlink Validation: Checks for malicious hyperlink patterns
- Path Traversal: File paths validated (needs SecurityManager integration)
- Sanitization: Automatic prefixing with single quote for dangerous content

No additional security concerns found.

### Performance Considerations

**Good Performance Architecture**

- Streaming validation for datasets >100 receipts ✓
- Chunk processing to avoid UI blocking ✓
- Target <500ms for 100 receipts (needs benchmarking)
- Progress tracking during validation ✓

Recommendations:
- Add performance benchmarks to verify <500ms target
- Consider caching validation results during session
- Implement validation debouncing in UI

### Files Modified During Review

None - no refactoring required during review.

### Requirements Traceability

**AC1: Pre-flight validation check** ✓
- Implemented in ExportValidator with ValidationReportDialog
- Given: User clicks export, When: validation runs, Then: warnings shown

**AC2: Field format validation** ✓
- DateFormatValidator, AmountFormatValidator, MerchantNameValidator implemented
- Given: Receipt data, When: validated, Then: format issues detected

**AC3: Required field verification** ✓
- Null checks in validators, empty field detection
- Given: Missing fields, When: validated, Then: errors returned

**AC4: Success confirmation** ✓
- ExportSuccessDialog with file location, share functionality
- Given: Successful export, When: complete, Then: location shown

**AC5: Edge case handling** ✓
- Empty list handling, CSV injection, validation timeouts
- Given: Edge cases, When: processed, Then: graceful handling

**AC6: Validation report** ✓
- ValidationReportDialog with categorized issues
- Given: Issues found, When: displayed, Then: user can review

### Test Architecture Assessment

**Test Coverage: Good but Incomplete**
- 11/13 unit tests passing (84.6%)
- Widget tests present for UI components
- Integration tests missing for complete flow
- Edge case tests defined but not all implemented

**Test Quality:**
- Good use of Given-When-Then patterns
- Tests cover happy path and error cases
- Security tests comprehensive for CSV injection
- Format-specific tests for QB/Xero present

### Non-Functional Requirements (NFRs)

**Security: PASS**
- Comprehensive CSV injection prevention
- Input sanitization implemented
- Path validation present (needs SecurityManager)

**Performance: CONCERNS**
- Architecture supports streaming for large datasets
- <500ms target defined but not benchmarked
- No performance tests implemented yet

**Reliability: PASS**
- Error handling with try-catch blocks
- Typed exceptions (ServiceException hierarchy)
- Recovery mechanisms via validation report

**Maintainability: PASS**
- Clean code structure with separation of concerns
- Self-documenting code with clear naming
- Comprehensive documentation in validators

### Technical Debt Identification

1. **TODO: Receipt fetching** - Line 439 in ExportScreen needs implementation
2. **Missing integration tests** - Complete flow not tested end-to-end
3. **Performance benchmarks** - No verification of <500ms target
4. **Deprecated APIs** - 5 instances of deprecated Material APIs
5. **Test failures** - 2 tests need fixing before production

### Gate Status

Gate: FAIL → docs/qa/gates/3.12-export-validation.yml
Risk profile: docs/qa/assessments/3.12-risk-20250110.md
NFR assessment: docs/qa/assessments/3.12-nfr-20250110.md

### Recommended Status

❌ **BLOCKED - Critical Implementation Missing**

**Story CANNOT be marked Done until:**
1. ✅ Receipt fetching is implemented (currently returns empty array)
2. ✅ QuickBooks import is verified with developer account
3. ✅ Xero import is verified with developer account
4. ✅ Validation runs on actual receipt data

**Current State:** The validation framework exists but is completely disconnected from real data. It's like building a car engine but never connecting it to the wheels - it looks complete but doesn't actually work.

**Developer Action Required:**
1. Replace line 439 empty array with actual repository call
2. Load test receipts into the app
3. Export CSV and test import in QuickBooks sandbox
4. Export CSV and test import in Xero sandbox
5. Document results and fix any import failures

**Note to Developer:** The user spent time setting up QuickBooks and Xero developer accounts specifically for this testing. The validation system MUST be tested with real imports to those platforms before this story can be considered complete.