# Story 3.10: CSV Format Options

## Status
Approved

## Story
**As a** Linda (Bookkeeper),
**I want** CSV format options,
**so that** I can match each client's system

## Acceptance Criteria
1. QuickBooks & Xero templates included
2. Format selection dropdown/radio buttons
3. Format persistence in app settings

_Note: These acceptance criteria expand on the single-line AC from the epic to provide clearer implementation guidance while maintaining the same core requirement._

## Tasks / Subtasks
- [ ] Task 1: Create CSV Format Selection UI Component (AC: 2)
  - [ ] Create FormatSelectionWidget in features/export/presentation/widgets/format_selection.dart
  - [ ] Implement Material 3 SegmentedButton or DropdownButton for format selection
  - [ ] Add format options: QuickBooks, Xero, Generic (using ExportFormat enum from CSVExportService)
  - [ ] Include format descriptions and compatibility info for each option
  - [ ] Apply Material 3 theming from core/theme/app_theme.dart
  - [ ] Implement WCAG 2.1 AA accessibility: proper labels, keyboard navigation, screen reader support
  - [ ] Create widget tests in test/widget/features/export/format_selection_test.dart

- [ ] Task 2: Implement Format State Management (AC: 2, 3)
  - [ ] Create ExportFormatProvider using Riverpod StateNotifier in features/export/presentation/providers/export_format_provider.dart
  - [ ] Define ExportFormatState model with selectedFormat, lastUsedFormat fields
  - [ ] Integrate with existing exportProvider for unified state management
  - [ ] Implement format change notification to update preview when format changes
  - [ ] Integrate with SettingsRepository to persist selected format preference
  - [ ] Create provider tests in test/unit/features/export/export_format_provider_test.dart

- [ ] Task 3: Enhance CSV Generation with Format Templates (AC: 1)
  - [ ] Review existing CSVExportService format implementations (QuickBooks, Xero, Generic)
  - [ ] Verify QuickBooks format compliance: Date (MM/dd/yyyy), Amount (0.00), required fields
  - [ ] Verify Xero format compliance: Date (dd/MM/yyyy), Amount (0.00), required fields
  - [ ] Ensure proper handling of notes field in all formats
  - [ ] Add format-specific validation rules to validateForExport method
  - [ ] Implement CSV injection prevention: sanitize special characters (=, +, -, @, tab, CR, LF)
  - [ ] Create comprehensive unit tests for each format in test/unit/domain/services/csv_export_service_test.dart

- [ ] Task 4: Update Export Screen with Format Selection (AC: 2)
  - [ ] Integrate FormatSelectionWidget into ExportScreen UI flow
  - [ ] Position format selector prominently before date range selection
  - [ ] Update export button handler to use selected format from provider
  - [ ] Ensure format selection persists between app sessions
  - [ ] Add visual feedback when format is changed
  - [ ] Update integration tests in test/widget/export/export_screen_test.dart

- [ ] Task 5: Update Settings Persistence (AC: 3)
  - [ ] Add exportFormat field to AppSettings model with default value ExportFormat.generic
  - [ ] Update SettingsRepository to handle format preference persistence
  - [ ] Add migration logic: if exportFormat is null, set to ExportFormat.generic
  - [ ] Ensure default format is set on first app launch (ExportFormat.generic)
  - [ ] Handle file system permissions for export directory access
  - [ ] Create settings persistence tests in test/unit/data/repositories/settings_repository_test.dart

## Dev Notes

### Previous Story Insights
From Story 3.9 (Date Range Selection for Export):
- Created comprehensive ExportScreen with tab-based format selection framework
- Integrated with existing CSVExportService for data export
- Established pattern for export feature providers and widgets
- Performance optimized with database indexing on receiptDate
- Settings persistence pattern established for user preferences
[Source: Story 3.9 Dev Agent Record]

### Data Models
- ExportFormat enum already exists in CSVExportService: quickbooks, xero, generic [Source: Found in codebase]
- QuickBooks format requirements: ["Date", "Amount", "Vendor", "Account"] with MM/dd/yyyy date format [Source: architecture/data-models.md]
- Xero format requirements: ["Date", "Amount", "Reference", "Description"] with dd/MM/yyyy date format [Source: architecture/data-models.md]
- Generic format requirements: ["Date", "Total", "Merchant", "Tax"] with YYYY-MM-DD date format [Source: architecture/data-models.md]
- All formats use UTF-8 encoding and "0.00" amount format [Source: architecture/data-models.md]
- Existing ValidationResult and ExportResult classes for handling export outcomes [Source: Found in codebase]

### API Specifications
- No external API calls required for this feature
- All format templates are locally defined in CSVExportService
- Export validation and generation are performed locally

### Component Specifications
- Export Feature Components: ExportSettings widget planned for export configuration [Source: architecture/core-workflows.md]
- Use Material 3 SegmentedButton for format selection (similar to date range preset options) [Source: architecture/frontend-architecture.md]
- Follow established Riverpod patterns with StateNotifier and AutoDispose [Source: architecture/tech-stack.md]
- Existing CSVExportService has format-specific generation methods: _generateQuickBooksCSV, _generateXeroCSV, _generateGenericCSV [Source: Found in codebase]

### File Locations
Based on project structure [Source: architecture/source-tree.md and actual file system]:
- Format selection widget: apps/mobile/lib/features/export/presentation/widgets/format_selection.dart
- Format provider: apps/mobile/lib/features/export/presentation/providers/export_format_provider.dart
- Export screen updates: apps/mobile/lib/features/export/presentation/pages/export_screen.dart
- Settings updates: apps/mobile/lib/data/models/app_settings.dart
- Widget tests: apps/mobile/test/widget/features/export/
- Unit tests: apps/mobile/test/unit/features/export/

### Technical Constraints
- Flutter 3.24+ required for Material 3 components [Source: architecture/tech-stack.md]
- Riverpod 2.4+ for state management [Source: architecture/tech-stack.md]
- CSV package 5.0+ for generation (already in use) [Source: architecture/tech-stack.md]
- Validation must ensure 100% format compatibility with QuickBooks/Xero [Source: architecture/core-workflows.md]
- Character encoding must be UTF-8 for all formats [Source: architecture/data-models.md]
- Follow immutable state pattern with copyWith methods [Source: architecture/coding-standards.md]

### Security Considerations
- CSV Injection Prevention: Sanitize all user-generated content before CSV export
- Special characters to escape: =, +, -, @, tab, CR, LF (prefix with single quote)
- File System Permissions: Ensure proper permissions for export directory
- No sensitive data exposure in export file names or paths
- Validate all file paths through SecurityManager.isValidPath()

### Accessibility Requirements
- Format selector must support keyboard navigation (Tab, Arrow keys)
- All format options must have descriptive labels for screen readers
- Selected format must be announced to screen readers
- Visual feedback for format selection must meet WCAG 2.1 AA contrast ratios
- Format descriptions must be accessible via aria-describedby

### Testing Requirements
From architecture standards [Source: architecture/coding-standards.md and architecture/testing-strategy.md]:
- Widget tests with 90%+ coverage target
- Use Given-When-Then pattern for test structure
- Test file location: apps/mobile/test/widget/features/export/ for UI tests
- Test file location: apps/mobile/test/unit/features/export/ for logic tests
- Mock repositories using Mockito as per existing patterns
- Test format-specific CSV generation for compliance
- Verify settings persistence across app restarts
- Test CSV injection prevention with malicious inputs
- Test accessibility compliance with keyboard and screen reader

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial draft of story 3.10 - CSV Format Options | Bob (Scrum Master) |
| 2025-01-12 | 1.1 | Applied QA validation fixes: Added security considerations, accessibility requirements, settings migration details, clarified AC alignment | Dev Agent |
| 2025-01-12 | 1.2 | Status updated from Ready for Review to Approved | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Not yet assigned

### Debug Log References
- Story validation completed using validate-next-story task
- Applied fixes based on validation findings (no formal QA gate yet)

### Completion Notes List
- Story ready for development
- Applied QA validation fixes:
  - Added security considerations for CSV injection prevention
  - Added WCAG 2.1 AA accessibility requirements
  - Clarified settings migration approach (default to ExportFormat.generic)
  - Added note about AC expansion from epic
  - Updated subtasks with security and accessibility implementation details

### File List
- Modified: docs/stories/3.10.story.md (this file)

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Summary
Story is well-prepared with comprehensive security and accessibility considerations added. The primary concern is the CSV injection vulnerability which requires careful implementation and thorough testing. Format compliance with QuickBooks/Xero must be verified with actual imports during development.

### Key Findings
1. **Security Risk (High)**: CSV injection vulnerability requires comprehensive sanitization of all user-generated content
2. **Data Risk (Medium)**: Format compliance needs verification with actual QuickBooks/Xero imports
3. **Test Gap (Medium)**: File system permission testing requires manual verification

### Risk Assessment
- Total Risks: 11 (0 Critical, 2 High, 5 Medium, 4 Low)
- Risk Score: 69/100 (Moderate Risk)
- Primary concerns: CSV injection and format compliance

### Test Coverage
- 28 test scenarios designed (12 P0, 11 P1, 5 P2)
- Strong unit test coverage (54%) for format validation
- Security testing prioritized for injection prevention
- All acceptance criteria have comprehensive coverage

### Recommendations
1. Implement CSV injection prevention as the first priority
2. Create test files from actual QuickBooks/Xero exports
3. Plan manual verification session for imports
4. Document file system permission requirements

### Gate Status

Gate: CONCERNS â†’ docs/qa/gates/3.10-csv-format-options.yml