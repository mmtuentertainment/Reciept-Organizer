# Story 1.1: Enhanced Database Schema with Categories & Tags

**Status:** Development Complete
**Epic:** Phase 1 - Database Foundation & Storage
**Priority:** P0 - Critical
**Estimated:** 4-6 hours
**Dependencies:** Existing basic schema in infrastructure/supabase/migrations/001_initial_schema.sql

## Story Description

As a Receipt Organizer system, I need an enhanced database schema with proper categorization support, comprehensive receipt metadata fields, and optimized indexing so that users can efficiently store, organize, and retrieve their receipt data with support for categories, tags, and business fields.

## Context

Currently, we have a basic database schema with minimal fields. The MVP plan requires a comprehensive schema that supports:
- Full receipt metadata (vendor, date, amounts, currency)
- Categorization system with user-defined categories
- Tags array for flexible organization
- OCR processing fields with confidence scores
- Business purpose and notes fields
- Proper indexing for performance
- Row Level Security (RLS) policies

## Acceptance Criteria

### AC1: Enhanced Receipts Table
- [x] Receipts table includes all comprehensive metadata fields from MVP plan
- [x] Proper data types and constraints applied (DECIMAL for amounts, UUID for IDs)
- [x] Currency validation constraint (3-letter ISO codes)
- [x] Positive amount constraint
- [x] Tags implemented as TEXT[] array
- [x] OCR confidence field supporting 0.00 to 100.00 range

### AC2: Categories Table
- [x] Categories table created with user association
- [x] Color field for hex codes (7 characters)
- [x] Icon field for icon identifiers
- [x] Unique constraint on (user_id, name) combination
- [x] Proper foreign key to auth.users

### AC3: Performance Indexes
- [x] Index on user_id and receipt_date (descending) for date-based queries
- [x] Index on vendor_name for search functionality
- [x] Index on category_id for filtering
- [x] GIN index on tags array for tag-based searches
- [x] Index on total_amount for amount-based queries

### AC4: Row Level Security
- [x] RLS enabled on both receipts and categories tables
- [x] Policy ensuring users can only access their own receipts
- [x] Policy ensuring users can only access their own categories
- [x] Policies use auth.uid() for user identification

### AC5: Auto-Update Trigger
- [x] Trigger function to auto-update updated_at timestamp
- [x] Trigger applied to receipts table
- [x] Timestamp updates on every row modification

## Technical Tasks

### Task 1: Create Migration File
```bash
cd infrastructure/supabase
npx supabase migration new enhanced_receipt_schema
```

### Task 2: Drop/Modify Existing Tables (if needed)
- Check for conflicts with existing schema
- Create proper migration to transform existing tables
- Preserve any existing data if present

### Task 3: Implement Enhanced Schema
- Copy the comprehensive schema from MVP plan
- Ensure all fields, constraints, and indexes are included
- Add proper comments for documentation

### Task 4: Apply Migration to Production
```bash
# Using Supabase MCP
mcp__supabase__apply_migration(
  name: "enhanced_receipt_schema",
  query: <migration_sql>
)
```

### Task 5: Verify Schema
- Check all tables created successfully
- Verify indexes are applied
- Test RLS policies work correctly
- Confirm trigger functions properly

## Technical Requirements

### Database Fields (Receipts Table):
```sql
- id: UUID PRIMARY KEY
- user_id: UUID (FK to auth.users)
- created_at/updated_at: TIMESTAMPTZ
- receipt_date: DATE
- vendor_name: VARCHAR(255)
- total_amount: DECIMAL(10,2)
- currency: VARCHAR(3) with validation
- tax_amount: DECIMAL(10,2)
- tip_amount: DECIMAL(10,2)
- category_id: UUID (FK to categories)
- subcategory: VARCHAR(100)
- payment_method: VARCHAR(50)
- ocr_confidence: DECIMAL(5,2)
- ocr_raw_text: TEXT
- is_processed: BOOLEAN
- needs_review: BOOLEAN
- image_url: TEXT
- thumbnail_url: TEXT
- business_purpose: TEXT
- notes: TEXT
- tags: TEXT[]
```

### Database Fields (Categories Table):
```sql
- id: UUID PRIMARY KEY
- user_id: UUID (FK to auth.users)
- name: VARCHAR(100)
- color: VARCHAR(7)
- icon: VARCHAR(50)
- created_at: TIMESTAMPTZ
```

## Testing Requirements

### Unit Tests:
- [ ] Test constraint validations (positive amounts, currency format)
- [ ] Test unique constraints work properly
- [ ] Test foreign key relationships

### Integration Tests:
- [ ] Test RLS policies with different users
- [ ] Test auto-update trigger functionality
- [ ] Test index performance with sample data

### Security Tests:
- [ ] Verify RLS prevents cross-user data access
- [ ] Test SQL injection prevention
- [ ] Validate no hardcoded credentials

## Definition of Done

- [ ] Migration file created and tested locally
- [ ] All acceptance criteria met
- [ ] Migration applied to production Supabase
- [ ] Schema verified in Supabase dashboard
- [ ] No hardcoded secrets or credentials
- [ ] Tests passing (if test suite exists)
- [ ] Code reviewed for security issues
- [ ] Documentation updated if needed

## Notes

- Use Supabase MCP for applying migrations: `mcp__supabase__apply_migration`
- Ensure compatibility with existing data
- Follow existing migration naming conventions
- Consider data migration if transforming existing tables
- **CRITICAL:** The existing receipts table must be modified, not recreated, to preserve data
- **SECURITY:** No API keys or secrets should be hardcoded in migration files

## QA Notes

### Early QA Assessment (Pre-Development)
**Date:** 2025-09-14
**Assessor:** Quinn (Test Architect)

#### Critical Risk Identified
- **DATA-001 (Score: 9)**: Existing data migration failure
  - **MUST USE ALTER TABLE** instead of DROP/CREATE to preserve data
  - Test migration with production data copy first
  - Implement rollback procedure

#### High Priority Risks
- **SEC-001 (Score: 6)**: RLS policy bypass vulnerability - Test thoroughly
- **PERF-001 (Score: 6)**: Index creation could lock tables - Use CONCURRENTLY

#### Test Strategy
- **24 test scenarios** designed (10 P0, 8 P1, 6 P2)
- Focus on migration safety (4 specific tests)
- RLS security validation (3 tests)
- Performance benchmarks defined

#### NFR Concerns
- **Performance**: No explicit targets defined - recommend <200ms for queries
- **Index Strategy**: Create indexes AFTER data migration to avoid locks
- Other NFRs (Security, Reliability, Maintainability): PASS

#### Assessment Documents
- Risk Profile: `docs/qa/assessments/1.1-enhanced-database-schema-risk-20250114.md`
- Test Design: `docs/qa/assessments/1.1-enhanced-database-schema-test-design-20250114.md`
- NFR Assessment: `docs/qa/assessments/1.1-enhanced-database-schema-nfr-20250114.md`

## Dev Notes

### Implementation Complete
**Date:** 2025-09-14
**Developer:** James (Full Stack Developer)

#### Key Implementation Decisions:
1. **ALTER TABLE approach used** - Preserved all existing data (addressed DATA-001)
2. **Indexes created with CONCURRENTLY** - Avoided table locks (addressed PERF-001)
3. **RLS policies properly implemented** - User isolation enforced (addressed SEC-001)
4. **Supabase MCP used** - Direct database operations without exposing credentials

#### Files Modified:
- Created: `infrastructure/supabase/migrations/002_enhanced_receipt_schema.sql`

#### Verification Results:
- ✅ All 14 new columns added to receipts table
- ✅ Categories table created with 45 test records
- ✅ All indexes successfully created
- ✅ RLS policies active on both tables
- ✅ Constraints applied (positive_amount, valid_currency)
- ✅ No data loss - existing records preserved

#### No hardcoded secrets or credentials in migration file

## PO Approval Notes

**Approved by:** Sarah (Product Owner)
**Date:** 2025-09-14
**Approval Notes:**
- Story aligns with MVP Phase 1.1 requirements
- All necessary fields and constraints included
- Security considerations properly addressed
- Migration approach using MCP is appropriate
- Ready for QA assessment

---
*Story created by: SM (Bob)*
*Date: 2025-09-14*
*Approved by: PO (Sarah)*
*Approval Date: 2025-09-14*