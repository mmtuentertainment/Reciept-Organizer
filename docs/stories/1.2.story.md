title: Story 1.2 - Auto Edge Detection
status: Approved
epic: 1
story_number: 2

story_statement: |
  As Mike (Freelance Contractor),
  I want automatic edge detection for receipts during capture,
  so that I don't waste time manually cropping and can focus on my work with 80%+ success rate on standard receipts.

acceptance_criteria:
  1: 80%+ success rate on standard receipts
  2: Auto-detect receipt edges during camera preview
  3: Visual overlay shows detected boundaries
  4: Manual adjustment handles available when auto-detection fails
  5: Processing happens in real-time during camera preview
  6: Fallback to manual crop when auto-detection confidence is low

tasks:
  implement_realtime_edge_detection:
    title: Implement Real-time Edge Detection
    ac_refs: [2, 5]
    subtasks:
      - Integrate OpenCV for Flutter edge detection algorithms
      - Configure Canny edge detection with receipt-optimized parameters
      - Implement contour detection to find rectangular boundaries
      - Add confidence scoring for detected edges (0-100%)
      - Optimize processing frequency for 30fps camera preview
  
  create_visual_edge_overlay:
    title: Create Visual Edge Overlay System
    ac_refs: [3]
    subtasks:
      - Design overlay widget with adjustable corner handles
      - Implement dynamic boundary line drawing on camera preview
      - Add visual feedback for edge detection confidence (colors/styles)
      - Create smooth animations for boundary updates
      - Handle overlay positioning for different screen sizes
  
  manual_adjustment_interface:
    title: Manual Adjustment Interface
    ac_refs: [4, 6]
    subtasks:
      - Add draggable corner handles for manual boundary adjustment
      - Implement pinch/zoom gesture for fine-tuning corners
      - Create reset button to retry auto-detection
      - Add haptic feedback for manual adjustments
      - Store user corrections to improve future detection
  
  service_integration:
    title: Edge Detection Service Integration
    ac_refs: [1, 6]
    subtasks:
      - Extend ICameraService interface with detectEdges() method
      - Implement EdgeDetectionResult model with confidence and bounds
      - Add preprocessing pipeline (grayscale, blur, contrast enhancement)
      - Configure auto-detection thresholds based on 80% success target
      - Implement fallback logic when confidence < 60%
  
  performance_optimization:
    title: Performance and Memory Optimization
    subtasks:
      - Limit edge detection to every 3rd camera frame (10fps processing)
      - Implement frame downsizing for detection (maintain aspect ratio)
      - Add memory cleanup for image processing operations
      - Profile edge detection CPU usage and optimize algorithms
      - Cache detection results to reduce duplicate processing

dev_context:
  previous_story_insights: |
    From Story 1.1 completion:
    - Google ML Kit integration established with comprehensive mock framework
    - Memory management patterns implemented and tested (peak usage <75MB)
    - Camera service architecture ready for extension with detectEdges() method
    - Performance monitoring systems in place for tracking processing times

  architecture_context:
    platform: Flutter 3.24+ cross-platform mobile application with offline-first design
    camera_integration: camera_2 package with receipt-optimized settings from Story 1.1
    image_processing: OpenCV for Flutter to be added for edge detection algorithms
    state_management: Riverpod 2.4+ with reactive state updates for real-time preview
    source: architecture.md#high_level_architecture

  data_models:
    edge_detection_result:
      purpose: New model with boundingBox coordinates, confidence score, processingTimeMs
    crop_bounds:
      purpose: Rectangle coordinates for manual adjustment (top-left, bottom-right points)
    camera_frame:
      purpose: Existing model from Story 1.1 for camera preview stream
    capture_result:
      purpose: Extend existing model to include EdgeDetectionResult
    source: architecture.md#data_models

  service_interfaces:
    camera_service_extensions:
      detect_edges: New method returning Future<EdgeDetectionResult>
      apply_crop: Existing method for manual boundary adjustment
      real_time_integration: Integrate with existing getPreviewStream() for live detection
    source: architecture.md#api_specification

  file_locations:
    edge_detection_service: apps/mobile/lib/infrastructure/services/edge_detection_service.dart
    camera_service_extension: apps/mobile/lib/infrastructure/services/camera_service.dart
    ui_components: apps/mobile/lib/presentation/camera/widgets/edge_overlay_widget.dart
    models: apps/mobile/lib/domain/models/edge_detection_result.dart
    source: architecture.md#unified_project_structure

  ui_components:
    edge_overlay_widget: Draws boundary lines with corner handles over camera preview
    corner_handle_widget: Draggable circles at rectangle corners for manual adjustment
    confidence_indicator: Visual feedback showing edge detection confidence with color coding
    processing_indicator: Shows when edge detection is active during preview
    source: architecture.md#components

  performance_requirements:
    real_time_processing: Edge detection at 10fps (every 3rd camera frame at 30fps)
    detection_time: <100ms per frame for edge detection processing
    memory_budget: <10MB additional usage for OpenCV operations
    success_rate_target: 80%+ automatic detection on standard receipt photos
    cpu_usage: <25% additional CPU load during camera preview
    source: architecture.md#security_and_performance

  opencv_integration:
    package: opencv_flutter package for native OpenCV integration
    algorithms: Canny edge detection + contour finding for rectangular shapes
    preprocessing: Grayscale conversion, Gaussian blur, contrast enhancement
    configuration: Optimized parameters for receipt detection (aspect ratios, size limits)
    source: architecture.md#tech_stack

  testing_standards:
    widget_tests: Edge overlay components using flutter_test framework
    unit_tests: Edge detection algorithms with test image assets
    integration_tests: Full camera preview with edge detection flow
    performance_tests: Memory usage and frame rate during edge detection
    test_coverage: Minimum 80% for edge detection service and UI components
    test_organization: test/unit/services/, test/widget/camera/, test/integration/
    source: architecture.md#testing_strategy

  project_structure_notes: |
    Aligns with established architecture - no conflicts identified. 
    Edge detection components fit naturally into existing service and presentation layers.

change_log:
  - date: 2025-09-06
    version: 1.0
    description: Initial story creation with architecture context
    author: Bob (Scrum Master)

dev_agent_record:
  agent_model: (To be populated by Dev Agent)
  debug_log_references: (To be populated by Dev Agent)
  completion_notes: (To be populated by Dev Agent)
  file_list: (To be populated by Dev Agent)

qa_results: (To be populated by QA Agent)